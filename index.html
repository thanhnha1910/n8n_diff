<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DiffChecker - Advanced Document Comparison Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap");
      :root {
        --bg-color: #f8f9fa;
        --surface-color: #ffffff;
        --border-color: #e5e7eb;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --color-red: #fef2f2;
        --color-red-text: #991b1b;
        --color-green: #f0fdf4;
        --color-green-text: #166534;
        --color-blue: #667eea;

        /* Fixed line constraint variables - ZOOM INDEPENDENT */
        --line-height: 1.4;
        --font-size: 14px;
        --fixed-lines: 25; /* Increased from 15 to 25 for better content visibility */
        --line-height-px: calc(var(--line-height) * var(--font-size));
        --padding-compensation: 16px; /* Optimized padding: 8px top + 8px bottom */
        --fixed-content-height: calc(
          var(--fixed-lines) * var(--line-height-px) +
            var(--padding-compensation)
        );

        /* Zoom-level consistency - ensures consistent lines at any zoom */
        --zoom-base-font: 14px;
        --zoom-base-line-height: 1.4;
        --zoom-compensation: 1;

        /* Enhanced viewport-based scaling */
        --viewport-width: 100vw;
        --viewport-height: 100vh;
        --content-scale: clamp(0.8, 1vw, 1.2);
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px; /* Reduced from 40px to 20px for better space utilization */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        position: relative;
      }

      /* Ultra-Fast Reading Controls */
      .reading-progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1000;
        cursor: pointer;
        transition: height 0.2s ease;
      }

      .reading-progress-bar:hover {
        height: 8px;
      }

      .reading-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.1s ease;
        position: relative;
      }

      .reading-progress-fill::after {
        content: attr(data-progress);
        position: absolute;
        right: 10px;
        top: -25px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .reading-progress-bar:hover .reading-progress-fill::after {
        opacity: 1;
      }

      .main-container {
        width: 100%;
        max-width: 1400px;
        background: var(--surface-color);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 700px; /* Increased to accommodate more lines */
        max-height: 95vh; /* Increased from 90vh to 95vh for better space utilization */
      }
      .header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
      }
      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
        min-width: 0;
      }

      .header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        flex-shrink: 0;
      }

      .header-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-top: 2px;
      }

      /* Enhanced Diff Summary Container */
      .diff-summary-container {
        position: relative;
        margin-top: 12px;
      }

      .total-diff-counter {
        padding: 12px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: none; /* Hidden by default */
        align-items: center;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
        border: 2px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(15px);
        min-width: 160px;
        justify-content: center;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-family: "Inter", sans-serif;
      }

      .total-diff-counter::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s ease;
      }

      .total-diff-counter:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .total-diff-counter:hover::before {
        left: 100%;
      }

      .total-diff-counter:hover .dropdown-arrow {
        transform: rotate(180deg);
      }

      .total-diff-counter:active {
        transform: translateY(-1px) scale(1.02);
      }

      /* Enhanced Dropdown Menu Styles */
      .diff-dropdown {
        position: absolute;
        top: calc(100% + 12px);
        left: 0;
        right: 0;
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 20px;
        box-shadow: 
          0 25px 80px rgba(0, 0, 0, 0.15),
          0 10px 30px rgba(0, 0, 0, 0.1),
          0 0 0 1px rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(102, 126, 234, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-20px) scale(0.92);
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 1000;
        max-height: 450px;
        overflow: hidden;
        backdrop-filter: blur(25px) saturate(180%);
        min-width: 380px;
        position: relative;
      }

      .diff-dropdown::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(145deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
        border-radius: 20px;
        pointer-events: none;
      }

      .diff-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0) scale(1);
      }

      .diff-dropdown-header {
        padding: 20px 24px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-bottom: none;
        font-size: 0.9rem;
        font-weight: 800;
        color: white;
        border-radius: 20px 20px 0 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        overflow: hidden;
      }

      .diff-dropdown-header::before {
        content: "üìç";
        font-size: 1.2rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }

      .diff-dropdown-header::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.05) 100%);
        pointer-events: none;
      }

      .diff-dropdown-list {
        max-height: 320px;
        overflow-y: auto;
        padding: 8px 0;
        scrollbar-width: thin;
        scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
      }

      .diff-dropdown-list::-webkit-scrollbar {
        width: 6px;
      }

      .diff-dropdown-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .diff-dropdown-list::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
      }

      .diff-dropdown-list::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.5);
      }

      .diff-dropdown-item {
        padding: 18px 24px;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border-left: 5px solid transparent;
        display: block;
        font-size: 0.9rem;
        margin: 6px 12px;
        border-radius: 14px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(102, 126, 234, 0.08);
      }

      .diff-dropdown-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 0;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: -1;
      }

      .diff-dropdown-item::after {
        content: "";
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%) scale(0);
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .diff-dropdown-item:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.08) 100%);
        border-left-color: #667eea;
        border-color: rgba(102, 126, 234, 0.2);
        transform: translateX(6px) scale(1.02);
        box-shadow: 
          0 8px 25px rgba(102, 126, 234, 0.15),
          0 4px 12px rgba(102, 126, 234, 0.1);
      }

      .diff-dropdown-item:hover::before {
        width: 100%;
      }

      .diff-dropdown-item:hover::after {
        transform: translateY(-50%) scale(1);
      }

      .diff-dropdown-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-left-color: #4c51bf;
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateX(6px) scale(1.02);
        box-shadow: 
          0 12px 35px rgba(102, 126, 234, 0.25),
          0 6px 15px rgba(102, 126, 234, 0.15);
      }

      .diff-dropdown-item.active::after {
        background: white;
        transform: translateY(-50%) scale(1.2);
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }

      .diff-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .diff-file-info {
        margin: 8px 0 10px 0;
        padding: 8px 12px;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 8px;
        border-left: 3px solid rgba(102, 126, 234, 0.3);
      }

      .file-change-description {
        font-size: 0.8rem;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 4px;
      }

      .file-direction-indicator {
        font-size: 0.75rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      }

      .file-direction {
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.7rem;
      }

      .file-direction.addition {
        background: rgba(5, 150, 105, 0.1);
        color: #059669;
        border: 1px solid rgba(5, 150, 105, 0.2);
      }

      .file-direction.removal {
        background: rgba(220, 38, 38, 0.1);
        color: #dc2626;
        border: 1px solid rgba(220, 38, 38, 0.2);
      }

      .file-direction.modification {
        background: rgba(124, 58, 237, 0.1);
        color: #7c3aed;
        border: 1px solid rgba(124, 58, 237, 0.2);
      }

      .diff-dropdown-item.active .diff-file-info {
        background: rgba(255, 255, 255, 0.15);
        border-left-color: rgba(255, 255, 255, 0.5);
      }

      .diff-dropdown-item.active .file-change-description {
        color: rgba(255, 255, 255, 0.9);
      }

      .diff-dropdown-item.active .file-direction {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
      }

      .diff-item-content {
        margin-left: 4px;
      }

      .diff-content-preview {
        font-size: 0.8rem;
        color: #4a5568;
        line-height: 1.4;
        margin-bottom: 6px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        background: rgba(0, 0, 0, 0.02);
        padding: 6px 8px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .diff-change-preview {
        font-size: 0.75rem;
        margin-top: 6px;
      }

      .diff-before, .diff-after {
        margin: 2px 0;
        padding: 4px 6px;
        border-radius: 3px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      }

      .diff-before {
        background: rgba(220, 38, 38, 0.1);
        border-left: 3px solid #dc2626;
      }

      .diff-after {
        background: rgba(5, 150, 105, 0.1);
        border-left: 3px solid #059669;
      }

      .diff-label {
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .diff-dropdown-item.active .diff-content-preview {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .diff-dropdown-item.active .diff-before {
        background: rgba(255, 255, 255, 0.1);
        border-left-color: rgba(255, 255, 255, 0.6);
      }

      .diff-dropdown-item.active .diff-after {
        background: rgba(255, 255, 255, 0.1);
        border-left-color: rgba(255, 255, 255, 0.6);
      }

      .diff-item-type {
        display: inline-flex;
        align-items: center;
        font-weight: 700;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        padding: 4px 8px;
        border-radius: 12px;
        min-width: 80px;
        justify-content: center;
        border: 1px solid;
      }

      .diff-item-type.addition {
        color: #059669;
        background: rgba(5, 150, 105, 0.1);
        border-color: rgba(5, 150, 105, 0.3);
      }

      .diff-item-type.removal {
        color: #dc2626;
        background: rgba(220, 38, 38, 0.1);
        border-color: rgba(220, 38, 38, 0.3);
      }

      .diff-item-type.modification {
        color: #7c3aed;
        background: rgba(124, 58, 237, 0.1);
        border-color: rgba(124, 58, 237, 0.3);
      }

      .diff-dropdown-item.active .diff-item-type {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border-color: rgba(255, 255, 255, 0.4);
      }

      .diff-item-line {
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
      }

      .diff-dropdown-item.active .diff-item-line {
        background: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
      }

      /* Difference Counter and Navigation - Improved Layout */
      .diff-counter-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        flex-shrink: 0;
        margin: 20px auto;
        padding: 16px 24px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(139, 92, 246, 0.2);
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.1);
        max-width: 600px;
        width: fit-content;
      }

      .diff-counter {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 24px;
        font-size: 0.9rem;
        font-weight: 600;
        box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
        min-width: 160px;
        justify-content: center;
        letter-spacing: 0.025em;
      }

      .diff-counter:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(139, 92, 246, 0.4);
        background: linear-gradient(135deg, #9333ea 0%, #8b5cf6 100%);
      }

      .diff-counter-icon {
        width: 20px;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        flex-shrink: 0;
      }

      /* Dropdown list for differences */
      .diff-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        min-width: 280px;
        margin-top: 8px;
        display: none;
      }

      .diff-dropdown.show {
        display: block;
      }

      .diff-dropdown-item {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.875rem;
      }

      .diff-dropdown-item:hover {
        background-color: rgba(139, 92, 246, 0.05);
      }

      .diff-dropdown-item:last-child {
        border-bottom: none;
      }

      .diff-dropdown-item.active {
        background-color: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
        font-weight: 600;
      }

      .diff-type-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
      }

      .diff-type-badge.added {
        background-color: rgba(34, 197, 94, 0.1);
        color: #16a34a;
      }

      .diff-type-badge.removed {
        background-color: rgba(239, 68, 68, 0.1);
        color: #dc2626;
      }

      .diff-type-badge.modified {
        background-color: rgba(245, 158, 11, 0.1);
        color: #d97706;
      }

      .diff-navigation {
        display: flex;
        gap: 8px;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px;
        border-radius: 14px;
        border: 0.5px solid var(--border-color);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }

      .nav-btn {
        width: 38px;
        height: 38px;
        border: none;
        border-radius: 10px;
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 16px;
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .nav-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
      }

      .nav-btn:active {
        transform: scale(0.98);
      }

      .nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
        background: rgba(139, 92, 246, 0.05);
      }

      .nav-btn:disabled:hover {
        background: rgba(139, 92, 246, 0.05);
        transform: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      /* Difference highlighting improvements */
      .diff-highlight {
        position: relative;
        background: linear-gradient(90deg, 
          rgba(102, 126, 234, 0.15) 0%, 
          rgba(102, 126, 234, 0.08) 50%, 
          rgba(102, 126, 234, 0.15) 100%) !important;
        border-left: 4px solid rgba(102, 126, 234, 0.6) !important;
        border-radius: 6px !important;
        animation: highlightPulse 1s ease-in-out;
        transform: scale(1.02);
        transition: all 0.3s ease;
      }

      .line-container.diff-highlight {
        background: linear-gradient(90deg, 
          rgba(102, 126, 234, 0.1) 0%, 
          rgba(102, 126, 234, 0.05) 50%, 
          rgba(102, 126, 234, 0.1) 100%) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2) !important;
      }

      @keyframes highlightPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.6);
          transform: scale(1.02);
        }
        50% {
          box-shadow: 0 0 0 12px rgba(102, 126, 234, 0.1);
          transform: scale(1.03);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.2);
          transform: scale(1.02);
        }
      }

      /* File info display */
      .file-info {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .file-name {
        font-weight: 500;
        color: var(--text-primary);
        background: rgba(103, 126, 234, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
      }

      .diff-stats {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .stat-added {
        color: #059669;
      }
      .stat-removed {
        color: #dc2626;
      }
      .stat-modified {
        color: #d97706;
      }
      .btn-reset {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: var(--text-primary);
        border: 0.5px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        padding: 8px 16px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .btn-reset:hover {
        background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
        border-color: #9ca3af;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .btn-reset:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .btn-reset svg {
        transition: transform 0.2s ease;
      }
      .btn-reset:hover svg {
        transform: rotate(180deg);
      }
      /* Sticky toolbar */
      .toolbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border-color);
        padding: 8px 24px;
        display: none; /* Hidden by default, shown when diff is active */
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .toolbar.active {
        display: flex;
      }

      .toolbar-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .toolbar-btn {
        background: rgba(103, 126, 234, 0.1);
        border: 1px solid rgba(103, 126, 234, 0.2);
        color: var(--color-blue);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .toolbar-btn:hover {
        background: rgba(103, 126, 234, 0.15);
        border-color: rgba(103, 126, 234, 0.3);
      }

      .content-area {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      }
      .diff-side {
        flex: 1;
        padding: 4px; /* Minimal padding for compact layout */
        border-right: 1px solid var(--border-color);
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0; /* Prevent flex item from overflowing */
        gap: 4px; /* Small gap between elements */
      }
      .diff-side:last-child {
        border-right: none;
      }

      /* File header within each pane */
      .file-header {
        background: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        padding: 8px 12px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .file-title {
        font-family: "JetBrains Mono", monospace;
        color: var(--text-primary);
        font-weight: 600;
      }

      /* File Statistics Headers */
      .file-stats-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid var(--border-color);
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 32px;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .file-stats-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .file-stats-title span {
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
      }

      .file-stats-badge {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        transition: all 0.2s ease;
        letter-spacing: 0.025em;
      }

      .file-stats-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
      }

      .file-stats-badge::before {
        content: "üìä";
        font-size: 0.75rem;
      }

      .file-stats-summary {
        display: flex;
        gap: 6px;
        align-items: center;
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .stats-item {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 0.65rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 3px;
        transition: all 0.2s ease;
      }

      .stats-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stats-item.additions {
        color: var(--color-green-text);
        border-color: rgba(22, 101, 52, 0.2);
        background: rgba(240, 253, 244, 0.8);
      }

      .stats-item.removals {
        color: var(--color-red-text);
        border-color: rgba(153, 27, 27, 0.2);
        background: rgba(254, 242, 242, 0.8);
      }

      .stats-item.modifications {
        color: #1d4ed8;
        border-color: rgba(29, 78, 216, 0.2);
        background: rgba(239, 246, 255, 0.8);
      }
      .upload-zone {
        border: 1.5px dashed var(--border-color);
        border-radius: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin: 8px;
        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
        min-height: calc(
          var(--fixed-lines) * var(--line-height-px) + 16px + 2px
        ); /* Match file-content-view height with new line count */
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .upload-zone::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(103, 126, 234, 0.05) 0%,
          rgba(103, 126, 234, 0.02) 100%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .upload-zone:hover {
        border-color: rgba(103, 126, 234, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(103, 126, 234, 0.15);
      }

      .upload-zone:hover::before {
        opacity: 1;
      }

      .upload-zone.drag-over {
        border-color: var(--color-blue);
        background: linear-gradient(135deg, #f0f2ff 0%, #e8f0ff 100%);
        transform: scale(1.02);
        box-shadow: 0 12px 30px rgba(103, 126, 234, 0.2);
      }

      .upload-zone p {
        color: var(--text-secondary);
        margin: 8px 0;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        z-index: 1;
      }

      .upload-zone strong {
        color: var(--color-blue);
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      .upload-zone .upload-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.7;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .upload-zone:hover .upload-icon {
        opacity: 1;
        transform: scale(1.1);
      }
      .file-content-view {
        font-family: "JetBrains Mono", monospace;
        font-size: var(--font-size);
        line-height: var(--line-height);
        white-space: pre-wrap;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        flex: 0 0 auto; /* Don't grow or shrink */
        overflow-y: auto;
        overflow-x: hidden;
        padding: 4px 8px; /* Minimal padding for optimal space usage */
        margin: 8px; /* Consistent margin with upload-zone */
        border: 0.5px solid var(--border-color);
        border-radius: 6px;
        background-color: #fafafa;
        box-sizing: border-box; /* Include padding and border in height calculation */

        /* Fixed line constraint - CORE FEATURE - RESPONSIVE LINE COUNT */
        height: calc(
          var(--fixed-lines) * var(--line-height-px) + 8px + 2px
        ); /* Dynamic lines + minimal padding + border */
        max-height: calc(
          var(--fixed-lines) * var(--line-height-px) + 8px + 2px
        );
        min-height: calc(
          var(--fixed-lines) * var(--line-height-px) + 8px + 2px
        );

        /* Enhanced smooth scrolling */
        scroll-behavior: smooth;
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;

        /* GPU Acceleration & Performance Optimizations */
        will-change: transform, scroll-position;
        transform: translateZ(0); /* Force GPU layer */
        contain: layout style paint; /* Isolate repaints */
        backface-visibility: hidden; /* Optimize 3D transforms */

        /* Smooth scrolling performance */
        -webkit-overflow-scrolling: touch; /* iOS momentum scrolling */

        /* Optimize rendering */
        image-rendering: optimizeSpeed;
        text-rendering: optimizeSpeed;

        /* Reduce reflow/repaint */
        position: relative;
        z-index: 1;

        /* Zoom-level consistency enforcement */
        box-sizing: border-box;
        resize: none;
      }

      /* Enhanced scrollbar styling for fixed content view */
      .file-content-view::-webkit-scrollbar {
        width: 8px;
      }

      .file-content-view::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 4px;
      }

      .file-content-view::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        transition: background 0.2s ease;
      }

      .file-content-view::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }
      .line-container {
        display: flex;
        align-items: flex-start;
        margin-bottom: 2px; /* Reduced spacing for better visual continuity */
        border-radius: 6px;
        transition: all 0.3s ease;
        position: relative;
        border: 2px solid transparent;
      }

      /* Enhanced line container highlighting for differences */
      .line-container.has-difference {
        border: 2px solid rgba(59, 130, 246, 0.3);
        background-color: rgba(59, 130, 246, 0.05);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
      }

      .line-container.has-addition {
        border: 2px solid rgba(34, 197, 94, 0.4);
        background-color: rgba(34, 197, 94, 0.08);
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.15);
      }

      .line-container.has-deletion {
        border: 2px solid rgba(239, 68, 68, 0.4);
        background-color: rgba(239, 68, 68, 0.08);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
      }

      .line-container.has-modification {
        border: 2px solid rgba(245, 158, 11, 0.4);
        background-color: rgba(245, 158, 11, 0.08);
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
      }

      /* Line numbers with enhanced styling */
      .line-number {
        display: inline-block;
        width: 45px;
        padding: 4px 8px;
        background-color: #f8fafc;
        color: var(--text-secondary);
        font-size: 12px;
        text-align: right;
        border-right: 2px solid var(--border-color);
        margin-right: 10px;
        user-select: none;
        flex-shrink: 0;
        font-weight: 500;
        border-radius: 4px 0 0 4px;
      }

      /* Enhanced line number styling for different types */
      .line-container.has-addition .line-number {
        background-color: rgba(34, 197, 94, 0.1);
        border-right-color: rgba(34, 197, 94, 0.3);
        color: #059669;
        font-weight: 600;
      }

      .line-container.has-deletion .line-number {
        background-color: rgba(239, 68, 68, 0.1);
        border-right-color: rgba(239, 68, 68, 0.3);
        color: #dc2626;
        font-weight: 600;
      }

      .line-container.has-modification .line-number {
        background-color: rgba(245, 158, 11, 0.1);
        border-right-color: rgba(245, 158, 11, 0.3);
        color: #d97706;
        font-weight: 600;
      }

      .line {
        padding: 4px 12px;
        display: block;
        flex: 1;
        min-height: 24px;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: pre-wrap;
        max-width: 100%;
        box-sizing: border-box;
        border-radius: 0 4px 4px 0;
        position: relative;
      }

      /* Enhanced line styling with better visual indicators */
      .line.added {
        background: linear-gradient(
          90deg,
          rgba(34, 197, 94, 0.15) 0%,
          rgba(34, 197, 94, 0.08) 100%
        );
        border-left: 4px solid #22c55e;
        color: #065f46;
        font-weight: 500;
      }

      .line.deleted {
        background: linear-gradient(
          90deg,
          rgba(239, 68, 68, 0.15) 0%,
          rgba(239, 68, 68, 0.08) 100%
        );
        border-left: 4px solid #ef4444;
        color: #7f1d1d;
        font-weight: 500;
      }

      .line.modified-old {
        background: linear-gradient(
          90deg,
          rgba(239, 68, 68, 0.12) 0%,
          rgba(239, 68, 68, 0.06) 100%
        );
        border-left: 4px solid #f59e0b;
        color: #7c2d12;
        font-weight: 500;
      }

      .line.modified-new {
        background: linear-gradient(
          90deg,
          rgba(34, 197, 94, 0.12) 0%,
          rgba(34, 197, 94, 0.06) 100%
        );
        border-left: 4px solid #f59e0b;
        color: #064e3b;
        font-weight: 500;
      }

      .line.empty {
        background: linear-gradient(
          90deg,
          rgba(156, 163, 175, 0.1) 0%,
          rgba(156, 163, 175, 0.05) 100%
        );
        border-left: 4px solid #e5e7eb;
        min-height: 24px;
        position: relative;
      }

      /* Add visual indicator for empty lines */
      .line.empty::after {
        content: "‚àÖ";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 14px;
        opacity: 0.6;
      }

      /* Enhanced inline diff highlighting */
      .inline-deleted {
        background-color: #f5c6cb;
        color: #721c24;
        border: 2px solid #dc3545;
        border-radius: 4px;
        padding: 2px 4px;
        margin: 0 1px;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .inline-deleted:hover {
        background-color: #f1b0b7;
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        transform: translateY(-1px);
      }

      .inline-added {
        background-color: #c3e6cb;
        color: #155724;
        border: 2px solid #28a745;
        border-radius: 4px;
        padding: 2px 4px;
        margin: 0 1px;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .inline-added:hover {
        background-color: #b8dabd;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transform: translateY(-1px);
      }

      /* Enhanced container classes for synchronized highlighting */
      .line-container.has-deletion {
        border-left: 4px solid #dc3545;
        background: linear-gradient(
          90deg,
          rgba(220, 53, 69, 0.05) 0%,
          transparent 100%
        );
      }

      .line-container.has-addition {
        border-left: 4px solid #28a745;
        background: linear-gradient(
          90deg,
          rgba(40, 167, 69, 0.05) 0%,
          transparent 100%
        );
      }

      .line-container.has-modification {
        border-left: 4px solid #ffc107;
        background: linear-gradient(
          90deg,
          rgba(255, 193, 7, 0.05) 0%,
          transparent 100%
        );
      }

      /* Synchronized hover effects */
      .line-container[data-line-pair]:hover {
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.08) 0%,
          rgba(59, 130, 246, 0.02) 100%
        ) !important;
        border-left-color: #3b82f6 !important;
        transition: all 0.2s ease;
        transform: scale(1.01);
        z-index: 5;
      }

      /* Enhanced visual indicators for line pairs */
      .line-container[data-line-pair]::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: transparent;
        transition: all 0.2s ease;
      }

      .line-container[data-line-pair]:hover::after {
        background: linear-gradient(
          to bottom,
          #3b82f6,
          rgba(59, 130, 246, 0.3)
        );
        box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
      }

      /* Fast scroll synchronization indicator */
      .file-content-view {
        scroll-behavior: auto;
      }

      /* Enhanced line number styling for synchronized lines */
      .line-container[data-line-pair] .line-number {
        position: relative;
      }

      .line-container[data-line-pair] .line-number::before {
        content: "";
        position: absolute;
        left: -2px;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #6c757d;
        opacity: 0.3;
        transition: all 0.2s ease;
      }

      .line-container[data-line-pair]:hover .line-number::before {
        background: #3b82f6;
        opacity: 1;
        transform: translateY(-50%) scale(1.5);
      }

      .inline-modified {
        background-color: #ffeaa7;
        color: #856404;
        border: 2px solid #ffc107;
        border-radius: 4px;
        padding: 2px 4px;
        margin: 0 1px;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
      }

      /* Advanced Line Matching Styles */
      .correspondence-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        margin-right: 6px;
        position: relative;
        animation: pulse 2s infinite;
        box-shadow: 0 0 6px rgba(59, 130, 246, 0.4);
      }

      .correspondence-indicator::after {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 50%;
        animation: ripple 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      @keyframes ripple {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }

      /* Match Quality Indicators */
      .match-quality-excellent {
        border-left-color: #10b981 !important;
        background: linear-gradient(
          90deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(16, 185, 129, 0.02) 100%
        );
      }

      .match-quality-excellent .line {
        box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.2);
      }

      .match-quality-good {
        border-left-color: #3b82f6 !important;
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(59, 130, 246, 0.02) 100%
        );
      }

      .match-quality-good .line {
        box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.2);
      }

      .match-quality-fair {
        border-left-color: #f59e0b !important;
        background: linear-gradient(
          90deg,
          rgba(245, 158, 11, 0.1) 0%,
          rgba(245, 158, 11, 0.02) 100%
        );
      }

      .match-quality-fair .line {
        box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.2);
      }

      .match-quality-poor {
        border-left-color: #ef4444 !important;
        background: linear-gradient(
          90deg,
          rgba(239, 68, 68, 0.1) 0%,
          rgba(239, 68, 68, 0.02) 100%
        );
      }

      .match-quality-poor .line {
        box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.2);
      }

      /* Enhanced correspondence highlighting */
      .line-container[data-has-correspondence="true"] {
        position: relative;
      }

      .line-container[data-has-correspondence="true"]::after {
        content: "";
        position: absolute;
        right: -1px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(
          to bottom,
          rgba(59, 130, 246, 0.8) 0%,
          rgba(59, 130, 246, 0.4) 50%,
          rgba(59, 130, 246, 0.8) 100%
        );
        border-radius: 0 2px 2px 0;
      }

      /* Similarity-based visual feedback */
      .line-container[data-similarity] {
        position: relative;
      }

      .line-container[data-similarity]::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: calc(var(--similarity) * 4px);
        background: linear-gradient(
          to right,
          rgba(16, 185, 129, 0.6),
          rgba(59, 130, 246, 0.6)
        );
        transition: all 0.3s ease;
      }

      /* Hover effects for correspondence lines */
      .line-container[data-has-correspondence="true"]:hover {
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.12) 0%,
          rgba(59, 130, 246, 0.04) 100%
        ) !important;
        transform: translateX(2px);
      }

      /* Enhanced empty line styling */
      .line.empty {
        background: linear-gradient(
          90deg,
          rgba(156, 163, 175, 0.08) 0%,
          rgba(156, 163, 175, 0.02) 100%
        );
        border-left: 4px solid #e5e7eb;
        min-height: 24px;
        position: relative;
        border-radius: 0 4px 4px 0;
      }

      .line.empty::after {
        content: "‚åÄ";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 12px;
        opacity: 0.5;
        font-weight: 300;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      /* ===== FAST SCROLLING ENHANCEMENTS ===== */

      /* Global fast scrolling behavior */
      html {
        scroll-behavior: auto;
      }

      /* Enhanced scrollbar styling for webkit browsers */
      .file-content-view::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }

      .file-content-view::-webkit-scrollbar-track {
        background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .file-content-view::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #cbd5e1, #94a3b8);
        border-radius: 10px;
        border: 2px solid #f8fafc;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .file-content-view::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #94a3b8, #64748b);
        border-color: #e2e8f0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        transform: scale(1.05);
      }

      .file-content-view::-webkit-scrollbar-thumb:active {
        background: linear-gradient(to bottom, #64748b, #475569);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .file-content-view::-webkit-scrollbar-corner {
        background: #f8fafc;
        border-radius: 10px;
      }

      /* Enhanced fast scrolling for content areas */
      .file-content-view {
        scroll-behavior: auto;
        scroll-padding-top: 20px;
        scroll-padding-bottom: 20px;

        /* Additional GPU optimizations for scrolling */
        transform: translate3d(0, 0, 0); /* Force hardware acceleration */
        -webkit-transform: translate3d(0, 0, 0);
        -moz-transform: translate3d(0, 0, 0);
        -ms-transform: translate3d(0, 0, 0);

        /* Optimize scroll performance */
        -webkit-backface-visibility: hidden;
        -moz-backface-visibility: hidden;
        -ms-backface-visibility: hidden;
        backface-visibility: hidden;
        overflow-x: hidden;
        overflow-y: auto;
        /* Enable momentum scrolling on iOS */
        -webkit-overflow-scrolling: touch;
        /* Improve scrolling performance */
        will-change: scroll-position;
      }

      /* Smooth scroll synchronization between panels */
      .diff-side {
        position: relative;
      }

      .diff-side .file-content-view {
        /* Enhanced scroll performance */
        contain: layout style paint;
        /* Smooth momentum scrolling */
        overscroll-behavior: contain;
        /* Better scroll snapping */
        scroll-snap-type: y proximity;
      }

      /* Smooth line transitions during scroll */
      .line-container {
        scroll-snap-align: start;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Enhanced scroll indicators */
      .file-content-view::before {
        content: "";
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(59, 130, 246, 0.3) 20%,
          rgba(59, 130, 246, 0.6) 50%,
          rgba(59, 130, 246, 0.3) 80%,
          transparent 100%
        );
        z-index: 10;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .file-content-view.scrolling::before {
        opacity: 1;
      }

      /* Smooth fade-in animation for content during scroll */
      .line-container {
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      /* Enhanced scroll performance optimizations */
      .file-content-view * {
        /* Optimize rendering during scroll */
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }

      /* Custom scrollbar for Firefox */
      .file-content-view {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f8fafc;
      }

      /* Smooth scroll button styling (if needed) */
      .scroll-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        z-index: 1000;
      }

      .scroll-to-top.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .scroll-to-top:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }

      .scroll-to-top:active {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      /* Enhanced scroll synchronization visual feedback */
      .diff-side.syncing {
        position: relative;
      }

      .diff-side.syncing::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 3px;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(59, 130, 246, 0.8),
          rgba(59, 130, 246, 0.4),
          rgba(59, 130, 246, 0.8)
        );
        animation: syncPulse 1s ease-in-out infinite;
        z-index: 5;
      }

      @keyframes syncPulse {
        0%,
        100% {
          opacity: 0.3;
          transform: scaleY(1);
        }
        50% {
          opacity: 1;
          transform: scaleY(1.02);
        }
      }

      /* Smooth transitions for line highlighting during scroll */
      .line-container.scroll-highlight {
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.1) 0%,
          rgba(59, 130, 246, 0.05) 100%
        );
        border-left-color: #3b82f6;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateX(2px);
      }

      /* Enhanced momentum scrolling for better mobile experience */
      @media (max-width: 768px) {
        .file-content-view {
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
          overscroll-behavior-y: contain;
        }

        .file-content-view::-webkit-scrollbar {
          width: 8px;
        }

        .file-content-view::-webkit-scrollbar-thumb {
          border-radius: 6px;
          border: 1px solid #f8fafc;
        }
      }

      /* Smooth scroll performance optimizations */
      .file-content-view {
        /* Enable hardware acceleration */
        transform: translateZ(0);
        /* Optimize compositing */
        will-change: scroll-position;
        /* Improve scroll performance */
        contain: layout style paint;
      }

      .inline-modified:hover {
        background-color: #fdcb6e;
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        transform: translateY(-1px);
      }

      /* Border highlighting for differences */
      .inline-deleted.needs-border {
        border: 3px solid #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
      }

      .inline-added.needs-border {
        border: 3px solid #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.3);
      }

      /* Enhanced animations for newly highlighted differences */
      @keyframes highlightPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(255, 193, 7, 0.3);
          transform: scale(1.05);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
          transform: scale(1);
        }
      }

      @keyframes slideInFromLeft {
        0% {
          opacity: 0;
          transform: translateX(-20px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideInFromRight {
        0% {
          opacity: 0;
          transform: translateX(20px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .inline-added.new-highlight {
        animation: highlightPulse 1s ease-out, slideInFromRight 0.5s ease-out;
      }

      .inline-deleted.new-highlight {
        animation: highlightPulse 1s ease-out, slideInFromLeft 0.5s ease-out;
      }

      .inline-modified.new-highlight {
        animation: highlightPulse 1s ease-out;
      }

      /* Smooth fade-in for results */
      .results-container {
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .footer {
        padding: 20px 30px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        flex-shrink: 0;
        background-color: var(--surface-color);
        position: sticky;
        bottom: 0;
        z-index: 10;
      }
      .btn {
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-primary {
        background-color: var(--color-blue);
        color: white;
      }
      .btn-primary:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        animation: fadeIn 0.3s ease-out;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid var(--color-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }
      .loading-text {
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        text-align: center;
      }
      .loading-progress {
        width: 200px;
        height: 4px;
        background-color: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 8px;
      }
      .loading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-blue), #4f46e5);
        border-radius: 2px;
        animation: progressPulse 2s ease-in-out infinite;
        width: 0%;
        transition: width 0.3s ease;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes progressPulse {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 1;
        }
      }

      /* Enhanced scrollbar styling */
      .file-content-view::-webkit-scrollbar {
        width: 8px;
      }
      .file-content-view::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .file-content-view::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      .file-content-view::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* Responsive adjustments */
      @media (max-height: 600px) {
        .main-container {
          height: 90vh;
          max-height: none;
        }
      }

      /* Enhanced responsive design maintaining 15-line constraint */
      @media (max-width: 1280px) {
        .main-container {
          max-width: 1200px;
        }
        .header h1 {
          font-size: 1.1rem;
        }
        .file-info {
          gap: 12px;
        }
        .toolbar {
          padding: 6px 20px;
        }
      }

      @media (max-width: 1024px) {
        body {
          padding: 16px;
        }
        .main-container {
          max-width: 100%;
          border-radius: 8px;
        }
        .header {
          padding: 12px 20px;
        }
        .header h1 {
          font-size: 1rem;
        }
        .file-info {
          gap: 8px;
          font-size: 0.8rem;
        }
        .file-name {
          font-size: 0.75rem;
          padding: 3px 6px;
        }
        .toolbar {
          padding: 6px 16px;
        }
        .toolbar-btn {
          padding: 4px 8px;
          font-size: 0.75rem;
        }
        /* Maintain responsive line constraint on smaller screens */
        :root {
          --font-size: 13px;
          --line-height-px: calc(var(--line-height) * var(--font-size));
        }
        .file-content-view {
          height: calc(var(--fixed-lines) * var(--line-height-px) + 8px + 2px);
          max-height: calc(
            var(--fixed-lines) * var(--line-height-px) + 8px + 2px
          );
          min-height: calc(
            var(--fixed-lines) * var(--line-height-px) + 8px + 2px
          );
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 12px;
        }
        .main-container {
          border-radius: 6px;
        }
        .header-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .file-info {
          order: 2;
          align-self: stretch;
          justify-content: space-between;
        }
        .btn-reset {
          order: 3;
          align-self: flex-end;
          font-size: 0.8rem;
          padding: 6px 12px;
        }
        .content-area {
          flex-direction: column;
        }
        .diff-side {
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }
        .diff-side:last-child {
          border-bottom: none;
        }
        .toolbar {
          flex-direction: column;
          gap: 8px;
          padding: 8px 16px;
        }
        .toolbar-actions {
          justify-content: center;
        }
        /* Maintain responsive line constraint on mobile */
        :root {
          --font-size: 12px;
          --line-height-px: calc(var(--line-height) * var(--font-size));
        }
        .file-content-view {
          height: calc(var(--fixed-lines) * var(--line-height-px) + 8px + 2px);
          max-height: calc(
            var(--fixed-lines) * var(--line-height-px) + 8px + 2px
          );
          min-height: calc(
            var(--fixed-lines) * var(--line-height-px) + 8px + 2px
          );
        }
        .line-number {
          width: 30px;
          font-size: 10px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }
        .main-container {
          height: 90vh;
          border-radius: 8px;
        }
        .header,
        .footer {
          padding: 15px 20px;
        }
        .diff-side {
          padding: 15px;
        }
        .file-content-view {
          font-size: 11px;
          padding: 10px;
        }
        .btn {
          padding: 8px 16px;
          font-size: 0.9rem;
        }
      }

      /* File name display */
      .file-name-display {
        font-size: 12px;
        color: var(--text-secondary);
        padding: 8px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
        font-weight: 500;
        border-radius: 8px 8px 0 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Content loading state */
      .content-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        flex: 1;
        color: var(--text-secondary);
        font-style: italic;
      }

      /* Improved button hover effects */
      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* File content stats */
      .file-stats {
        font-size: 11px;
        color: var(--text-secondary);
        margin-left: auto;
      }

      /* Error message styling */
      .error-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 20px;
        color: var(--text-primary);
      }

      .error-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .error-title {
        font-size: 18px;
        font-weight: 600;
        color: #dc2626;
        margin-bottom: 8px;
      }

      .error-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .error-suggestion {
        font-size: 12px;
        color: var(--color-blue);
        background-color: #f0f2ff;
        padding: 8px 12px;
        border-radius: 6px;
        border-left: 3px solid var(--color-blue);
      }

      .comparison-error {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        margin: 20px;
      }

      /* Difference counter styles */
      #diffCounterContainer {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      #diffCountText {
        margin: 0;
        font-size: 14px;
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background-color 0.2s;
      }

      #diffCountText:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: background-color 0.2s;
      }

      .nav-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
      }

      .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Highlight styles for current difference */
      .diff-highlight {
        position: relative;
        box-shadow: 0 0 0 2px #007acc !important;
        border-radius: 3px;
        animation: highlightPulse 0.5s ease-in-out;
      }

      @keyframes highlightPulse {
        0% {
          box-shadow: 0 0 0 2px #007acc;
        }
        50% {
          box-shadow: 0 0 0 4px rgba(0, 122, 204, 0.5);
        }
        100% {
          box-shadow: 0 0 0 2px #007acc;
        }
      }

      /* Enhanced difference visibility */
      .line.added,
      .line-container.added {
        background-color: rgba(46, 160, 67, 0.2) !important;
        border-left: 3px solid #2ea043;
      }

      .line.removed,
      .line-container.removed {
        background-color: rgba(248, 81, 73, 0.2) !important;
        border-left: 3px solid #f85149;
      }

      .line.modified-old,
      .line.modified-new,
      .line-container.modified {
        background-color: rgba(187, 128, 9, 0.2) !important;
        border-left: 3px solid #bb8009;
      }

      /* Override ƒë·ªÉ lo·∫°i b·ªè scroll-snap - kh·∫Øc ph·ª•c hi·ªán t∆∞·ª£ng bounce back */
      .diff-side .file-content-view {
        scroll-snap-type: none !important;
      }

      .line-container {
        scroll-snap-align: none !important;
      }

      /* T·∫Øt hi·ªáu ·ª©ng n·∫∑ng khi ƒëang cu·ªôn ƒë·ªÉ c·∫£i thi·ªán hi·ªáu su·∫•t */
      .file-content-view.scrolling .line-container {
        transition: none !important;
      }

      .file-content-view.scrolling .inline-added,
      .file-content-view.scrolling .inline-deleted {
        box-shadow: none !important;
      }

      /* ===== Scroll: nh·∫°y & kh√¥ng gi·∫≠t ===== */

      /* 1) T·∫Øt smooth trong pane (tr√°nh ƒë·ªô tr·ªÖ c·∫£m nh·∫≠n) */
      .file-content-view {
        scroll-behavior: auto !important;
        scrollbar-gutter: stable both-edges;
      }

      /* 2) T·∫Øt scroll-snap (tr√°nh bounce-back) */
      .diff-side .file-content-view {
        scroll-snap-type: none !important;
      }
      .line-container {
        scroll-snap-align: none !important;
      }

      /* 3) Khi ƒëang cu·ªôn th√¨ t·∫Øt m·ªçi transition/shadow n·∫∑ng ƒë·ªÉ kh√¥ng r·ªõt frame */
      .file-content-view.scrolling * {
        transition: none !important;
        box-shadow: none !important;
      }

      /* 4) B·∫£o to√†n hi·ªáu nƒÉng & tr√°nh "n·∫£y" ·ªü m√©p */
      .file-content-view {
        overscroll-behavior: contain;
        will-change: scroll-position;
      }

      /* 5) Scrollbar "d·ªÖ b√°m tay" + kh√¥ng x√™ d·ªãch layout */
      .file-content-view::-webkit-scrollbar {
        width: 12px;
      }
      .file-content-view::-webkit-scrollbar-thumb {
        border-radius: 10px;
      }
      .file-content-view:hover::-webkit-scrollbar-thumb {
        filter: brightness(0.9);
      }

      /* Diff Counter Visibility Fixes */
      #diffCounterContainer,
      .total-diff-counter {
        display: flex !important;
      }
      .diff-dropdown {
        display: none;
        position: absolute;
        z-index: 50;
      }
      .diff-dropdown.show {
        display: block;
      }

      /* Ensure panes scroll independently with no snap interference */
      .file-content-view {
        scroll-behavior: auto !important;
        overscroll-behavior: contain;
      }
      .diff-side .file-content-view {
        scroll-snap-type: none !important;
      }
      .line-container {
        scroll-snap-align: none !important;
      }

      /* Highlight when jumped to */
      .line-container.diff-highlight {
        outline: 2px solid #8b5cf6;
        outline-offset: 2px;
        transition: outline 0s;
      }

      /* Hide diff counter in empty state */
      body[data-has-diff="false"] .diff-counter-badge {
        display: none !important;
      }

      /* Ensure diff counter is visible when there are differences */
      body[data-has-diff="true"] #diffCounterContainer {
        display: flex !important;
      }
    </style>
  </head>
  <body data-has-diff="false">
    <!-- Ultra-Fast Reading Controls -->
    <div class="reading-progress-bar" id="reading-progress-bar">
      <div
        class="reading-progress-fill"
        id="reading-progress-fill"
        data-progress="0%"
      ></div>
    </div>

    <div class="main-container" id="main-container">
      <div class="header">
        <div class="header-content">
          <div class="header-left">
            <div>
              <h1>DiffChecker Pro 1.1</h1>
              <div class="header-subtitle">Advanced Document Comparison</div>
            </div>
            <div class="diff-summary-container" id="diffSummaryContainer">
              <div
                class="total-diff-counter"
                id="totalDiffCounter"
                title="Click to view all differences"
              >
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  style="margin-right: 6px"
                >
                  <path
                    d="M9 11H1l6-6v4.5c11 0 20 7.5 20 15-2.5-2.5-5.5-5-11-5z"
                  />
                </svg>
                <span class="total-diff-text" id="totalDiffText"
                  >0 differences</span
                >
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  style="margin-left: 6px; transition: transform 0.2s ease"
                  class="dropdown-arrow"
                  id="dropdownArrow"
                >
                  <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
              </div>

              <!-- Dropdown menu for individual differences -->
              <div class="diff-dropdown" id="diffDropdown">
                <div class="diff-dropdown-header">
                  <span>Jump to difference:</span>
                </div>
                <div class="diff-dropdown-list" id="diffDropdownList">
                  <!-- Individual differences will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <div class="file-info" id="file-info" style="display: none">
            <div class="file-name" id="file1-name">File 1</div>
            <div class="diff-stats" id="diff-stats">
              <span class="stat-item stat-added" id="added-count">+0</span>
              <span class="stat-item stat-removed" id="removed-count">-0</span>
              <span class="stat-item stat-modified" id="modified-count"
                >~0</span
              >
            </div>
            <div class="file-name" id="file2-name">File 2</div>
          </div>

          <button
            class="btn btn-reset"
            id="reset-btn"
            title="Start New Comparison"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
            Reset
          </button>
        </div>
      </div>

      <!-- Sticky Toolbar -->
      <div class="toolbar" id="toolbar">
        <div class="toolbar-actions">
          <button
            class="toolbar-btn"
            id="copy-btn"
            title="Copy diff to clipboard"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path
                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
              ></path>
            </svg>
            Copy
          </button>
          <button class="toolbar-btn" id="find-btn" title="Find in diff">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            Find
          </button>
          <button
            class="toolbar-btn"
            id="scroll-to-diff-btn"
            title="Scroll to first difference"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M7 13l3 3 7-7"></path>
              <path
                d="M21 21H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h18a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2z"
              ></path>
            </svg>
            First Diff
          </button>
        </div>
        <div class="toolbar-info">
          <span id="diff-position">Line 1 of 1</span>
        </div>
      </div>

      <div class="content-area">
        <div class="diff-side" id="side1">
          <!-- File Statistics Header for File 1 -->
          <div
            class="file-stats-header"
            id="file1-stats-header"
            style="display: none"
          >
            <div class="file-stats-title">
              <div class="file-stats-badge">üìÑ</div>
              <span id="file1-title">File 1</span>
            </div>
            <div class="file-stats-summary" id="file1-stats-summary">
              <div class="stats-item additions" id="file1-additions">
                +0 additions
              </div>
              <div class="stats-item removals" id="file1-removals">
                -0 removals
              </div>
            </div>
          </div>
          <div class="upload-zone" id="upload-zone-1">
            <svg
              class="upload-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,15 17,10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            <p>
              Drag and drop first document or
              <strong>click to browse files</strong>
            </p>
            <p
              style="
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-top: 8px;
              "
            >
              Supported formats: PDF, DOCX, TXT
            </p>
            <input
              type="file"
              id="file-input-1"
              accept=".pdf,.docx,.txt"
              hidden
            />
          </div>
        </div>
        <div class="diff-side" id="side2">
          <!-- File Statistics Header for File 2 -->
          <div
            class="file-stats-header"
            id="file2-stats-header"
            style="display: none"
          >
            <div class="file-stats-title">
              <div class="file-stats-badge">üìÑ</div>
              <span id="file2-title">File 2</span>
            </div>
            <div class="file-stats-summary" id="file2-stats-summary">
              <div class="stats-item additions" id="file2-additions">
                +0 additions
              </div>
              <div class="stats-item removals" id="file2-removals">
                -0 removals
              </div>
            </div>
          </div>
          <div class="upload-zone" id="upload-zone-2">
            <svg
              class="upload-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7,10 12,15 17,10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            <p>
              Drag and drop second document or
              <strong>click to browse files</strong>
            </p>
            <p
              style="
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-top: 8px;
              "
            >
              Supported formats: PDF, DOCX, TXT
            </p>
            <input
              type="file"
              id="file-input-2"
              accept=".pdf,.docx,.txt"
              hidden
            />
          </div>
        </div>
      </div>
      <div class="footer">
        <button class="btn btn-primary" id="run-task-btn" disabled>
          Compare Documents
        </button>
      </div>
    </div>

    <script>
      const N8N_WEBHOOK_URL =
        "https://quachnha33.app.n8n.cloud/webhook/file-diff";

      const fileInput1 = document.getElementById("file-input-1");
      const fileInput2 = document.getElementById("file-input-2");
      const uploadZone1 = document.getElementById("upload-zone-1");
      const uploadZone2 = document.getElementById("upload-zone-2");
      const side1 = document.getElementById("side1");
      const side2 = document.getElementById("side2");
      const runTaskBtn = document.getElementById("run-task-btn");
      const mainContainer = document.getElementById("main-container");

      let file1 = null;
      let file2 = null;

      // --- EVENT LISTENERS ---
      [uploadZone1, fileInput1].forEach((el) => {
        el.addEventListener("click", () => fileInput1.click());
        el.addEventListener("dragover", (e) => {
          e.preventDefault();
          el.classList.add("drag-over");
        });
        el.addEventListener("dragleave", (e) =>
          el.classList.remove("drag-over")
        );
        el.addEventListener("drop", (e) => handleFileDrop(e, 1));
        fileInput1.onchange = (e) => handleFileSelect(e, 1);
      });

      [uploadZone2, fileInput2].forEach((el) => {
        el.addEventListener("click", () => fileInput2.click());
        el.addEventListener("dragover", (e) => {
          e.preventDefault();
          el.classList.add("drag-over");
        });
        el.addEventListener("dragleave", (e) =>
          el.classList.remove("drag-over")
        );
        el.addEventListener("drop", (e) => handleFileDrop(e, 2));
        fileInput2.onchange = (e) => handleFileSelect(e, 2);
      });

      runTaskBtn.addEventListener("click", runComparison);

      // Reset button functionality
      const resetBtn = document.getElementById("reset-btn");
      resetBtn.addEventListener("click", resetComparison);

      // --- FUNCTIONS ---

      function resetComparison() {
        // Clear file variables
        file1 = null;
        file2 = null;

        // Clear file inputs
        fileInput1.value = "";
        fileInput2.value = "";

        // ENHANCED CLEANUP: Remove all existing event listeners and clean up state

        // 1. Clean up scroll synchronization event listeners
        const existingContentViews =
          document.querySelectorAll(".file-content-view");
        existingContentViews.forEach((view) => {
          // Clone and replace to remove all event listeners
          const newView = view.cloneNode(true);
          if (view.parentNode) {
            view.parentNode.replaceChild(newView, view);
          }
        });

        // 2. Clean up hover effect event listeners
        const existingLineContainers = document.querySelectorAll(
          ".line-container[data-line-pair]"
        );
        existingLineContainers.forEach((container) => {
          const newContainer = container.cloneNode(true);
          if (container.parentNode) {
            container.parentNode.replaceChild(newContainer, container);
          }
        });

        // 3. Remove all CSS classes that might affect layout
        [side1, side2].forEach((side) => {
          side.classList.remove(
            "syncing",
            "has-deletion",
            "has-addition",
            "has-modification"
          );
          side.style.cssText = ""; // Clear all inline styles

          // Remove any remaining diff-related classes from child elements
          const allElements = side.querySelectorAll("*");
          allElements.forEach((el) => {
            el.classList.remove(
              "syncing",
              "has-deletion",
              "has-addition",
              "has-modification",
              "match-quality-excellent",
              "match-quality-good",
              "match-quality-fair",
              "match-quality-poor",
              "new-highlight",
              "line-container",
              "correspondence-indicator"
            );
            el.style.cssText = ""; // Clear all inline styles
            el.removeAttribute("data-line-pair");
            el.removeAttribute("data-match-quality");
          });
        });

        // 4. Clear any global state variables that might affect layout
        if (window.scrollSyncManager) {
          window.scrollSyncManager = null;
        }
        if (window.diffNavigator) {
          window.diffNavigator = null;
        }

        // 5. Statistics will be reset as part of the HTML replacement below

        // 6. Reset upload zones with clean HTML (including statistics headers)
        side1.innerHTML = `
                <!-- File Statistics Header for File 1 -->
                <div class="file-stats-header" id="file1-stats-header" style="display: none">
                    <div class="file-stats-title">
                        <div class="file-stats-badge">üìÑ</div>
                        <span id="file1-title">File 1</span>
                    </div>
                    <div class="file-stats-summary" id="file1-stats-summary">
                        <div class="stats-item additions" id="file1-additions">+0 additions</div>
                        <div class="stats-item removals" id="file1-removals">-0 removals</div>
                    </div>
                </div>
                <div class="upload-zone" id="upload-zone-1">
                    <p>Drag and drop first document or <strong>click to browse files</strong></p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;">Supported formats: PDF, DOCX, TXT</p>
                    <input type="file" id="file-input-1" accept=".pdf,.docx,.txt" hidden>
                </div>
            `;

        side2.innerHTML = `
                <!-- File Statistics Header for File 2 -->
                <div class="file-stats-header" id="file2-stats-header" style="display: none">
                    <div class="file-stats-title">
                        <div class="file-stats-badge">üìÑ</div>
                        <span id="file2-title">File 2</span>
                    </div>
                    <div class="file-stats-summary" id="file2-stats-summary">
                        <div class="stats-item additions" id="file2-additions">+0 additions</div>
                        <div class="stats-item removals" id="file2-removals">-0 removals</div>
                    </div>
                </div>
                <div class="upload-zone" id="upload-zone-2">
                    <p>Drag and drop second document or <strong>click to browse files</strong></p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px;">Supported formats: PDF, DOCX, TXT</p>
                    <input type="file" id="file-input-2" accept=".pdf,.docx,.txt" hidden>
                </div>
            `;

        // 7. Re-assign elements and event listeners
        const newFileInput1 = document.getElementById("file-input-1");
        const newFileInput2 = document.getElementById("file-input-2");
        const newUploadZone1 = document.getElementById("upload-zone-1");
        const newUploadZone2 = document.getElementById("upload-zone-2");

        // Re-attach event listeners for side 1
        [newUploadZone1, newFileInput1].forEach((el) => {
          el.addEventListener("click", () => newFileInput1.click());
          el.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.classList.add("drag-over");
          });
          el.addEventListener("dragleave", (e) =>
            el.classList.remove("drag-over")
          );
          el.addEventListener("drop", (e) => handleFileDrop(e, 1));
          newFileInput1.onchange = (e) => handleFileSelect(e, 1);
        });

        // Re-attach event listeners for side 2
        [newUploadZone2, newFileInput2].forEach((el) => {
          el.addEventListener("click", () => newFileInput2.click());
          el.addEventListener("dragover", (e) => {
            e.preventDefault();
            el.classList.add("drag-over");
          });
          el.addEventListener("dragleave", (e) =>
            el.classList.remove("drag-over")
          );
          el.addEventListener("drop", (e) => handleFileDrop(e, 2));
          newFileInput2.onchange = (e) => handleFileSelect(e, 2);
        });

        // 8. Reset button states
        runTaskBtn.disabled = true;

        // 9. Clear any remaining diff counters or navigation elements
        const diffCounters = document.querySelectorAll(
          ".diff-counter, .diff-navigation, .difference-counter"
        );
        diffCounters.forEach((counter) => {
          counter.style.display = "none";
          counter.innerHTML = "";
        });

        // 10. Force layout recalculation to ensure clean state
        side1.offsetHeight; // Trigger reflow
        side2.offsetHeight; // Trigger reflow

        // Show success feedback
        const resetBtn = document.getElementById("reset-btn");
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Reset Complete
            `;
        resetBtn.style.background =
          "linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)";
        resetBtn.style.color = "#065f46";
        resetBtn.style.borderColor = "#10b981";

        setTimeout(() => {
          resetBtn.innerHTML = originalText;
          resetBtn.style.background = "";
          resetBtn.style.color = "";
          resetBtn.style.borderColor = "";
        }, 1500);
      }
      function validateFileType(file) {
        const allowedTypes = [".pdf", ".docx", ".txt"];
        const fileName = file.name.toLowerCase();
        const fileExtension = fileName.substring(fileName.lastIndexOf("."));
        return allowedTypes.includes(fileExtension);
      }

      function handleFileDrop(event, side) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (!validateFileType(file)) {
            alert(
              "Only PDF, DOCX and TXT files are supported. Please select a different file."
            );
            return;
          }
          if (side === 1) file1 = file;
          else file2 = file;
          renderFileContent(file, side);
        }
      }

      function handleFileSelect(event, side) {
        const files = event.target.files;
        if (files.length > 0) {
          const file = files[0];
          if (!validateFileType(file)) {
            alert(
              "Only PDF, DOCX and TXT files are supported. Please select a different file."
            );
            event.target.value = ""; // Clear the input
            return;
          }
          if (side === 1) file1 = file;
          else file2 = file;
          renderFileContent(file, side);
        }
      }

      async function renderFileContent(file, side) {
        const targetSide = side === 1 ? side1 : side2;
        const fileName = file.name.toLowerCase();
        const fileExtension = fileName.substring(fileName.lastIndexOf("."));

        // Show loading state with better visual feedback while preserving headers
        const existingHeader = targetSide.querySelector(".file-stats-header");
        const loadingHtml = `
                <div class="file-name-display">‚è≥ ${file.name}</div>
                <div class="content-loading">
                    <div class="spinner" style="width: 24px; height: 24px; margin-bottom: 12px;"></div>
                    <div style="font-weight: 500; margin-bottom: 4px;">Reading file...</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        ${
                          fileExtension === ".pdf"
                            ? "Extracting text from PDF document..."
                            : fileExtension === ".docx"
                            ? "Processing Word document..."
                            : "Reading text file..."
                        }
                    </div>
                </div>
            `;

        if (existingHeader) {
          // Keep header and update the rest
          targetSide.innerHTML = "";
          targetSide.appendChild(existingHeader);
          targetSide.innerHTML += loadingHtml;
        } else {
          targetSide.innerHTML = loadingHtml;
        }

        try {
          let textContent = "";

          if (fileExtension === ".txt") {
            // Handle TXT files
            textContent = await readTextFile(file);
          } else if (fileExtension === ".docx") {
            // Handle DOCX files
            textContent = await readDocxFile(file);
          } else if (fileExtension === ".pdf") {
            // Handle PDF files
            textContent = await readPdfFile(file);
          }

          // Store converted text for sending to N8N
          if (side === 1) {
            file1.convertedText = textContent;
          } else {
            file2.convertedText = textContent;
          }

          // Calculate file statistics
          const lines = textContent.split("\n").length;
          const chars = textContent.length;
          const sizeKB = (file.size / 1024).toFixed(1);

          // Update file content while preserving headers
          const existingHeader = targetSide.querySelector(".file-stats-header");
          const fileContentHtml = `
                    <div class="file-name-display">
                        üìÑ ${file.name}
                        <div class="file-stats">${lines} lines ‚Ä¢ ${chars} characters ‚Ä¢ ${sizeKB} KB</div>
                    </div>
                    <div class="file-content-view">${escapeHtml(
                      textContent
                    )}</div>
                `;

          if (existingHeader) {
            // Keep header and update the rest
            targetSide.innerHTML = "";
            targetSide.appendChild(existingHeader);
            targetSide.innerHTML += fileContentHtml;
            // Show the header now that we have content
            existingHeader.style.display = "flex";
          } else {
            targetSide.innerHTML = fileContentHtml;
          }
          checkRunButtonState();
        } catch (error) {
          console.error("Error reading file:", error);
          const errorMessage = getFileErrorMessage(error, fileExtension);
          // Show error while preserving headers
          const existingHeader = targetSide.querySelector(".file-stats-header");
          const errorHtml = `
                    <div class="file-name-display">‚ùå ${file.name}</div>
                    <div class="file-content-view error-message">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <div class="error-title">Unable to read file</div>
                        <div class="error-description">${errorMessage}</div>
                        <div class="error-suggestion">
                            üí° Suggestion: Try selecting a different file or check the file format
                        </div>
                    </div>
                `;

          if (existingHeader) {
            // Keep header and update the rest
            targetSide.innerHTML = "";
            targetSide.appendChild(existingHeader);
            targetSide.innerHTML += errorHtml;
          } else {
            targetSide.innerHTML = errorHtml;
          }
        }
      }

      async function readTextFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(new Error("Unable to read TXT file"));
          reader.readAsText(file);
        });
      }

      async function readDocxFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const arrayBuffer = e.target.result;
              const result = await mammoth.extractRawText({
                arrayBuffer: arrayBuffer,
              });
              resolve(result.value);
            } catch (error) {
              reject(new Error("Unable to read DOCX file"));
            }
          };
          reader.onerror = (e) => reject(new Error("Unable to read DOCX file"));
          reader.readAsArrayBuffer(file);
        });
      }

      async function readPdfFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const arrayBuffer = e.target.result;
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer })
                .promise;
              let textContent = "";

              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();

                // Improved text extraction with better spacing
                let pageText = "";
                let lastY = null;

                for (let j = 0; j < content.items.length; j++) {
                  const item = content.items[j];
                  const currentY = item.transform[5];

                  // Add line break only when Y position changes significantly (new line)
                  if (lastY !== null && Math.abs(currentY - lastY) > 5) {
                    pageText += "\n";
                  } else if (
                    pageText &&
                    !pageText.endsWith(" ") &&
                    !item.str.startsWith(" ")
                  ) {
                    // Add space between words if needed
                    pageText += " ";
                  }

                  pageText += item.str;
                  lastY = currentY;
                }

                // Add page separator only if there's more content
                if (i < pdf.numPages && pageText.trim()) {
                  textContent += pageText + "\n";
                } else {
                  textContent += pageText;
                }
              }

              resolve(textContent.trim());
            } catch (error) {
              reject(new Error("Unable to read PDF file"));
            }
          };
          reader.onerror = (e) => reject(new Error("Unable to read PDF file"));
          reader.readAsArrayBuffer(file);
        });
      }

      function checkRunButtonState() {
        runTaskBtn.disabled = !(file1 && file2);
      }

      async function runComparison() {
        if (!file1 || !file2) return;

        try {
          // Update file names in header with tooltips
          const file1NameEl = document.getElementById("file1-name");
          const file2NameEl = document.getElementById("file2-name");
          const file1TitleEl = document.getElementById("file1-title");
          const file2TitleEl = document.getElementById("file2-title");

          if (file1NameEl) {
            file1NameEl.textContent = file1.name;
            file1NameEl.title = file1.name; // Tooltip
          }
          if (file2NameEl) {
            file2NameEl.textContent = file2.name;
            file2NameEl.title = file2.name; // Tooltip
          }
          if (file1TitleEl) {
            file1TitleEl.textContent = file1.name;
            file1TitleEl.title = file1.name; // Tooltip
          }
          if (file2TitleEl) {
            file2TitleEl.textContent = file2.name;
            file2TitleEl.title = file2.name; // Tooltip
          }

          // Step 1: Preparing files
          showLoading(true, "Preparing files for comparison...", 20);

          const formData = new FormData();

          // Always send converted text as TXT files
          const txtFile1 = new File(
            [file1.convertedText || ""],
            file1.name.replace(/\.(pdf|docx)$/i, ".txt"),
            { type: "text/plain" }
          );
          const txtFile2 = new File(
            [file2.convertedText || ""],
            file2.name.replace(/\.(pdf|docx)$/i, ".txt"),
            { type: "text/plain" }
          );

          formData.append("file1", txtFile1);
          formData.append("file2", txtFile2);

          // Step 2: Uploading to server
          showLoading(true, "Uploading files to server...", 40);

          const response = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.statusText}`);
          }

          // Step 3: Processing response
          showLoading(true, "Processing comparison results...", 70);

          const result = await response.json();

          if (result.error) {
            throw new Error(result.message);
          }

          // Step 4: Rendering results
          showLoading(true, "Displaying comparison results...", 90);

          // Apply advanced line matching algorithm
          const enhancedResult = applyAdvancedLineMatching(result);

          // Small delay to show final progress
          await new Promise((resolve) => setTimeout(resolve, 500));

          await displayDiffResults(enhancedResult);
        } catch (error) {
          console.error("Comparison error:", error);
          showLoading(false);

          // Show user-friendly error message
          const errorContainer = document.createElement("div");
          errorContainer.className = "comparison-error";
          errorContainer.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">‚ùå</div>
                        <div class="error-title">Comparison error</div>
                        <div class="error-description">${getComparisonErrorMessage(
                          error
                        )}</div>
                        <div class="error-suggestion">
                            üí° Suggestion: Check file content and try again
                        </div>
                    </div>
                `;

          side1.innerHTML = "";
          side2.innerHTML = "";
          side1.appendChild(errorContainer.cloneNode(true));
        } finally {
          showLoading(false);
        }
      }

      function applyAdvancedLineMatching(result) {
        if (!result.diff_result || !Array.isArray(result.diff_result)) {
          return result;
        }

        const diffResult = result.diff_result;
        const enhancedDiff = [];

        // Advanced line matching algorithm
        for (let i = 0; i < diffResult.length; i++) {
          const currentDiff = diffResult[i];

          // For modified lines, try to find better matches using similarity scoring
          if (currentDiff.type === "modified") {
            const similarity = calculateLineSimilarity(
              currentDiff.content1 || "",
              currentDiff.content2 || ""
            );

            // If similarity is very low, consider splitting into separate add/delete operations
            if (similarity < 0.3) {
              // Look ahead to see if there are better matches
              const betterMatch = findBetterLineMatch(
                currentDiff,
                diffResult,
                i
              );

              if (betterMatch) {
                enhancedDiff.push(...betterMatch);
                continue;
              }
            }

            // Enhance the modified line with better inline diff
            currentDiff.similarity = similarity;
            currentDiff.matchQuality = getMatchQuality(similarity);
          }

          // For added/deleted lines, try to find corresponding pairs
          if (currentDiff.type === "added" || currentDiff.type === "deleted") {
            const pairedLine = findCorrespondingLine(
              currentDiff,
              diffResult,
              i
            );
            if (pairedLine) {
              currentDiff.correspondingLine = pairedLine;
              currentDiff.hasCorrespondence = true;
            }
          }

          enhancedDiff.push(currentDiff);
        }

        // Apply line grouping for better visual organization
        const groupedDiff = groupRelatedLines(enhancedDiff);

        return {
          ...result,
          diff_result: groupedDiff,
        };
      }

      function calculateLineSimilarity(line1, line2) {
        if (!line1 && !line2) return 1.0;
        if (!line1 || !line2) return 0.0;

        // Normalize lines for comparison
        const normalized1 = line1.toLowerCase().trim().replace(/\s+/g, " ");
        const normalized2 = line2.toLowerCase().trim().replace(/\s+/g, " ");

        // Use Levenshtein distance for similarity calculation
        const distance = levenshteinDistance(normalized1, normalized2);
        const maxLength = Math.max(normalized1.length, normalized2.length);

        if (maxLength === 0) return 1.0;

        return 1 - distance / maxLength;
      }

      function levenshteinDistance(str1, str2) {
        const matrix = [];

        for (let i = 0; i <= str2.length; i++) {
          matrix[i] = [i];
        }

        for (let j = 0; j <= str1.length; j++) {
          matrix[0][j] = j;
        }

        for (let i = 1; i <= str2.length; i++) {
          for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j] + 1
              );
            }
          }
        }

        return matrix[str2.length][str1.length];
      }

      function findBetterLineMatch(currentDiff, diffResult, currentIndex) {
        const content1 = currentDiff.content1 || "";
        const content2 = currentDiff.content2 || "";

        // Look for better matches in nearby lines
        const searchRange = Math.min(5, diffResult.length - currentIndex - 1);
        let bestMatch = null;
        let bestSimilarity = 0;

        for (let i = 1; i <= searchRange; i++) {
          const nextIndex = currentIndex + i;
          if (nextIndex < diffResult.length) {
            const nextDiff = diffResult[nextIndex];

            if (nextDiff.type === "modified") {
              const similarity1 = calculateLineSimilarity(
                content1,
                nextDiff.content1 || ""
              );
              const similarity2 = calculateLineSimilarity(
                content2,
                nextDiff.content2 || ""
              );
              const avgSimilarity = (similarity1 + similarity2) / 2;

              if (avgSimilarity > bestSimilarity && avgSimilarity > 0.7) {
                bestSimilarity = avgSimilarity;
                bestMatch = {
                  index: nextIndex,
                  similarity: avgSimilarity,
                };
              }
            }
          }
        }

        // If no better match found, return null
        return null;
      }

      function findCorrespondingLine(targetDiff, diffResult, currentIndex) {
        const targetContent = targetDiff.content1 || targetDiff.content2 || "";
        const targetType = targetDiff.type;
        const oppositeType = targetType === "added" ? "deleted" : "added";

        // Search in a reasonable range around the current position
        const searchRange = 10;
        const startIndex = Math.max(0, currentIndex - searchRange);
        const endIndex = Math.min(
          diffResult.length,
          currentIndex + searchRange
        );

        let bestMatch = null;
        let bestSimilarity = 0;

        for (let i = startIndex; i < endIndex; i++) {
          if (i === currentIndex) continue;

          const candidateDiff = diffResult[i];
          if (candidateDiff.type === oppositeType) {
            const candidateContent =
              candidateDiff.content1 || candidateDiff.content2 || "";
            const similarity = calculateLineSimilarity(
              targetContent,
              candidateContent
            );

            if (similarity > bestSimilarity && similarity > 0.5) {
              bestSimilarity = similarity;
              bestMatch = {
                index: i,
                similarity: similarity,
                content: candidateContent,
              };
            }
          }
        }

        return bestMatch;
      }

      function getMatchQuality(similarity) {
        if (similarity >= 0.9) return "excellent";
        if (similarity >= 0.7) return "good";
        if (similarity >= 0.5) return "fair";
        return "poor";
      }

      function groupRelatedLines(diffResult) {
        const grouped = [];
        let currentGroup = [];
        let lastType = null;

        for (let i = 0; i < diffResult.length; i++) {
          const diff = diffResult[i];

          // Start a new group if type changes significantly
          if (lastType && lastType !== diff.type && currentGroup.length > 0) {
            // Add group metadata
            if (currentGroup.length > 1) {
              currentGroup[0].groupStart = true;
              currentGroup[currentGroup.length - 1].groupEnd = true;
              currentGroup.forEach((item, index) => {
                item.groupSize = currentGroup.length;
                item.groupIndex = index;
              });
            }

            grouped.push(...currentGroup);
            currentGroup = [];
          }

          currentGroup.push(diff);
          lastType = diff.type;
        }

        // Handle the last group
        if (currentGroup.length > 0) {
          if (currentGroup.length > 1) {
            currentGroup[0].groupStart = true;
            currentGroup[currentGroup.length - 1].groupEnd = true;
            currentGroup.forEach((item, index) => {
              item.groupSize = currentGroup.length;
              item.groupIndex = index;
            });
          }
          grouped.push(...currentGroup);
        }

        return grouped;
      }

      function calculateFileStatistics(diffResult) {
        let file1Stats = { additions: 0, removals: 0, modifications: 0 };
        let file2Stats = { additions: 0, removals: 0, modifications: 0 };

        diffResult.forEach((diff) => {
          switch (diff.type) {
            case "deleted":
              // Line exists in file 1 but deleted in file 2
              // This is a removal from file 1's perspective (content lost)
              file1Stats.removals++;
              break;
            case "added":
              // Line added in file 2 that doesn't exist in file 1
              // This is an addition to file 2's perspective (new content)
              file2Stats.additions++;
              break;
            case "modified":
              // Line modified in both files
              file1Stats.modifications++;
              file2Stats.modifications++;
              break;
          }
        });

        return { file1Stats, file2Stats };
      }

      function updateFileStatisticsDisplay(file1Stats, file2Stats) {
        // Update File 1 statistics
        const file1Header = document.getElementById("file1-stats-header");
        if (file1Header) {
          const file1Additions = document.getElementById("file1-additions");
          const file1Removals = document.getElementById("file1-removals");

          if (file1Additions) {
            file1Additions.textContent = `+${file1Stats.additions} additions`;
          }
          if (file1Removals) {
            file1Removals.textContent = `-${file1Stats.removals} removals`;
          }

          // Always show the statistics header during comparison
          file1Header.style.display = "flex";
        }

        // Update File 2 statistics
        const file2Header = document.getElementById("file2-stats-header");
        if (file2Header) {
          const file2Additions = document.getElementById("file2-additions");
          const file2Removals = document.getElementById("file2-removals");

          if (file2Additions) {
            file2Additions.textContent = `+${file2Stats.additions} additions`;
          }
          if (file2Removals) {
            file2Removals.textContent = `-${file2Stats.removals} removals`;
          }

          // Always show the statistics header during comparison
          file2Header.style.display = "flex";
        }
      }

      async function displayDiffResults(data) {
        const diffResult = data.diff_result || [];
        let html1 = "";
        let html2 = "";

        diffResult.forEach((diff, index) => {
          const escapedContent1 = escapeHtml(diff.content1);
          const escapedContent2 = escapeHtml(diff.content2);
          const lineNum1 = diff.displayLineNumber1
            ? `<span class="line-number">${diff.displayLineNumber1}</span>`
            : '<span class="line-number"></span>';
          const lineNum2 = diff.displayLineNumber2
            ? `<span class="line-number">${diff.displayLineNumber2}</span>`
            : '<span class="line-number"></span>';

          // Generate unique IDs for synchronized highlighting
          const lineId = `line-${index}`;
          const containerClass1 = getContainerClass(diff.type, "left");
          const containerClass2 = getContainerClass(diff.type, "right");

          // Add advanced matching attributes
          let matchingAttributes = "";
          let correspondenceIndicator = "";

          if (diff.similarity !== undefined) {
            matchingAttributes += ` data-similarity="${diff.similarity}" data-match-quality="${diff.matchQuality}"`;
          }

          if (diff.hasCorrespondence) {
            matchingAttributes += ` data-has-correspondence="true" data-correspondence-similarity="${diff.correspondingLine.similarity}"`;
            correspondenceIndicator = `<span class="correspondence-indicator" title="Similarity: ${Math.round(
              diff.correspondingLine.similarity * 100
            )}%"></span>`;
          }

          if (diff.groupStart) {
            matchingAttributes += ` data-group-start="true" data-group-size="${diff.groupSize}"`;
          }

          if (diff.groupEnd) {
            matchingAttributes += ` data-group-end="true"`;
          }

          switch (diff.type) {
            case "unchanged":
              html1 += `<div class="line-container" id="${lineId}-left" data-line-pair="${lineId}"${matchingAttributes}>${lineNum1}<span class="line">${escapedContent1}</span></div>`;
              html2 += `<div class="line-container" id="${lineId}-right" data-line-pair="${lineId}"${matchingAttributes}>${lineNum2}<span class="line">${escapedContent2}</span></div>`;
              break;
            case "deleted":
              html1 += `<div class="line-container ${containerClass1}" id="${lineId}-left" data-line-pair="${lineId}"${matchingAttributes}>${correspondenceIndicator}${lineNum1}<span class="line deleted">${escapedContent1}</span></div>`;
              html2 += `<div class="line-container ${containerClass2}" id="${lineId}-right" data-line-pair="${lineId}"${matchingAttributes}>${lineNum2}<span class="line empty"></span></div>`;
              break;
            case "added":
              html1 += `<div class="line-container ${containerClass1}" id="${lineId}-left" data-line-pair="${lineId}"${matchingAttributes}>${lineNum1}<span class="line empty"></span></div>`;
              html2 += `<div class="line-container ${containerClass2}" id="${lineId}-right" data-line-pair="${lineId}"${matchingAttributes}>${correspondenceIndicator}${lineNum2}<span class="line added">${escapedContent2}</span></div>`;
              break;
            case "modified":
              // Add similarity-based styling
              let qualityClass = "";
              if (diff.matchQuality) {
                qualityClass = ` match-quality-${diff.matchQuality}`;
              }

              // Check if inline diff is available from backend
              if (
                diff.inlineDiff &&
                diff.inlineDiff.segments1 &&
                diff.inlineDiff.segments2
              ) {
                // Render with backend inline highlighting
                const inlineHtml1 = renderInlineSegments(
                  diff.inlineDiff.segments1
                );
                const inlineHtml2 = renderInlineSegments(
                  diff.inlineDiff.segments2
                );
                html1 += `<div class="line-container ${containerClass1}${qualityClass}" id="${lineId}-left" data-line-pair="${lineId}"${matchingAttributes}>${lineNum1}<span class="line modified-old">${inlineHtml1}</span></div>`;
                html2 += `<div class="line-container ${containerClass2}${qualityClass}" id="${lineId}-right" data-line-pair="${lineId}"${matchingAttributes}>${lineNum2}<span class="line modified-new">${inlineHtml2}</span></div>`;
              } else {
                // Use client-side word-level diff for better highlighting
                const wordDiff = performWordLevelDiff(
                  diff.content1 || "",
                  diff.content2 || ""
                );
                const inlineHtml1 = renderInlineSegments(wordDiff.segments1);
                const inlineHtml2 = renderInlineSegments(wordDiff.segments2);
                html1 += `<div class="line-container ${containerClass1}${qualityClass}" id="${lineId}-left" data-line-pair="${lineId}"${matchingAttributes}>${lineNum1}<span class="line modified-old">${inlineHtml1}</span></div>`;
                html2 += `<div class="line-container ${containerClass2}${qualityClass}" id="${lineId}-right" data-line-pair="${lineId}"${matchingAttributes}>${lineNum2}<span class="line modified-new">${inlineHtml2}</span></div>`;
              }
              break;
          }
        });

        // Update only the file-content-view, preserving headers
        const fileContentView1 = side1.querySelector(".file-content-view");
        const fileContentView2 = side2.querySelector(".file-content-view");

        if (fileContentView1) {
          fileContentView1.innerHTML = html1;
        } else {
          side1.innerHTML += `<div class="file-content-view">${html1}</div>`;
        }

        if (fileContentView2) {
          fileContentView2.innerHTML = html2;
        } else {
          side2.innerHTML += `<div class="file-content-view">${html2}</div>`;
        }

        // Calculate and display file statistics
        const statistics = calculateFileStatistics(diffResult);
        updateFileStatisticsDisplay(
          statistics.file1Stats,
          statistics.file2Stats
        );

        // Add synchronized hover effects for line pairs
        addSynchronizedHoverEffects();

        // Add smooth scroll synchronization
        addScrollSynchronization();

        // Remove animation classes after animation completes
        setTimeout(() => {
          const animatedElements1 = side1.querySelectorAll(".new-highlight");
          const animatedElements2 = side2.querySelectorAll(".new-highlight");
          animatedElements1.forEach((element) => {
            element.classList.remove("new-highlight");
          });
          animatedElements2.forEach((element) => {
            element.classList.remove("new-highlight");
          });
        }, 1000);

        // Update differences counter after rendering is complete - using new race-free method
        console.log("=== Calling refreshDiffUI from displayDiffResults ===");
        await refreshDiffUI();
      }

      function getContainerClass(diffType, side) {
        switch (diffType) {
          case "deleted":
            return "has-deletion";
          case "added":
            return "has-addition";
          case "modified":
            return "has-modification";
          default:
            return "";
        }
      }

      function addSynchronizedHoverEffects() {
        const allLineContainers = document.querySelectorAll(
          ".line-container[data-line-pair]"
        );

        allLineContainers.forEach((container) => {
          container.addEventListener("mouseenter", function () {
            const pairId = this.getAttribute("data-line-pair");
            const pairedElements = document.querySelectorAll(
              `[data-line-pair="${pairId}"]`
            );

            pairedElements.forEach((element) => {
              element.style.transform = "scale(1.02)";
              element.style.zIndex = "5";
              element.style.boxShadow = "0 4px 16px rgba(59, 130, 246, 0.2)";
            });
          });

          container.addEventListener("mouseleave", function () {
            const pairId = this.getAttribute("data-line-pair");
            const pairedElements = document.querySelectorAll(
              `[data-line-pair="${pairId}"]`
            );

            pairedElements.forEach((element) => {
              element.style.transform = "";
              element.style.zIndex = "";
              element.style.boxShadow = "";
            });
          });
        });
      }

      function addScrollSynchronization() {
        const contentView1 = side1.querySelector(".file-content-view");
        const contentView2 = side2.querySelector(".file-content-view");

        if (!contentView1 || !contentView2) return;

        let isScrolling1 = false;
        let isScrolling2 = false;

        contentView1.addEventListener("scroll", function () {
          if (!isScrolling2) {
            isScrolling1 = true;
            const scrollPercentage =
              this.scrollTop / (this.scrollHeight - this.clientHeight);
            const targetScrollTop =
              scrollPercentage *
              (contentView2.scrollHeight - contentView2.clientHeight);
            contentView2.scrollTop = targetScrollTop;

            setTimeout(() => {
              isScrolling1 = false;
            }, 100);
          }
        });

        contentView2.addEventListener("scroll", function () {
          if (!isScrolling1) {
            isScrolling2 = true;
            const scrollPercentage =
              this.scrollTop / (this.scrollHeight - this.clientHeight);
            const targetScrollTop =
              scrollPercentage *
              (contentView1.scrollHeight - contentView1.clientHeight);
            contentView1.scrollTop = targetScrollTop;

            setTimeout(() => {
              isScrolling2 = false;
            }, 100);
          }
        });
      }

      function showLoading(isLoading, message = "Processing...", progress = 0) {
        let overlay = document.getElementById("loading-overlay");
        if (isLoading && !overlay) {
          overlay = document.createElement("div");
          overlay.id = "loading-overlay";
          overlay.className = "loading-overlay";
          overlay.innerHTML = `
                    <div class="spinner"></div>
                    <div class="loading-text">${message}</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        Please wait a moment...
                    </div>
                `;
          mainContainer.appendChild(overlay);

          // Animate progress bar
          if (progress > 0) {
            setTimeout(() => {
              const progressBar = overlay.querySelector(
                ".loading-progress-bar"
              );
              if (progressBar) {
                progressBar.style.width = progress + "%";
              }
            }, 100);
          }
        } else if (isLoading && overlay) {
          // Update existing overlay
          const loadingText = overlay.querySelector(".loading-text");
          const progressBar = overlay.querySelector(".loading-progress-bar");
          if (loadingText) loadingText.textContent = message;
          if (progressBar) progressBar.style.width = progress + "%";
        } else if (!isLoading && overlay) {
          overlay.style.opacity = "0";
          setTimeout(() => {
            if (overlay && overlay.parentNode) {
              overlay.remove();
            }
          }, 300);
        }
      }

      // Word-level diff algorithm
      function performWordLevelDiff(text1, text2) {
        if (!text1 && !text2) return { segments1: [], segments2: [] };
        if (!text1)
          return {
            segments1: [],
            segments2: [{ type: "added", text: text2 }],
          };
        if (!text2)
          return {
            segments1: [{ type: "deleted", text: text1 }],
            segments2: [],
          };

        const words1 = text1.split(/(\s+)/);
        const words2 = text2.split(/(\s+)/);

        const diff = diffWords(words1, words2);

        const segments1 = [];
        const segments2 = [];

        diff.forEach((change) => {
          if (change.added) {
            segments2.push({ type: "added", text: change.value });
          } else if (change.removed) {
            segments1.push({ type: "deleted", text: change.value });
          } else {
            segments1.push({ type: "unchanged", text: change.value });
            segments2.push({ type: "unchanged", text: change.value });
          }
        });

        return { segments1, segments2 };
      }

      function diffWords(words1, words2) {
        const m = words1.length;
        const n = words2.length;

        // Create LCS matrix
        const lcs = Array(m + 1)
          .fill()
          .map(() => Array(n + 1).fill(0));

        for (let i = 1; i <= m; i++) {
          for (let j = 1; j <= n; j++) {
            if (words1[i - 1] === words2[j - 1]) {
              lcs[i][j] = lcs[i - 1][j - 1] + 1;
            } else {
              lcs[i][j] = Math.max(lcs[i - 1][j], lcs[i][j - 1]);
            }
          }
        }

        // Backtrack to find differences
        const result = [];
        let i = m,
          j = n;

        while (i > 0 || j > 0) {
          if (i > 0 && j > 0 && words1[i - 1] === words2[j - 1]) {
            result.unshift({ value: words1[i - 1] });
            i--;
            j--;
          } else if (j > 0 && (i === 0 || lcs[i][j - 1] >= lcs[i - 1][j])) {
            result.unshift({ value: words2[j - 1], added: true });
            j--;
          } else if (i > 0) {
            result.unshift({ value: words1[i - 1], removed: true });
            i--;
          }
        }

        return result;
      }

      function renderInlineSegments(segments) {
        if (!segments || !Array.isArray(segments)) return "";

        return segments
          .map((segment) => {
            const escapedText = escapeHtml(segment.text);
            const borderClass = " needs-border new-highlight";
            switch (segment.type) {
              case "unchanged":
                return escapedText;
              case "deleted":
                return `<span class="inline-deleted${borderClass}">${escapedText}</span>`;
              case "added":
                return `<span class="inline-added${borderClass}">${escapedText}</span>`;
              default:
                return escapedText;
            }
          })
          .join("");
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function getFileErrorMessage(error, fileExtension) {
        const errorMsg = error.message.toLowerCase();

        if (errorMsg.includes("network") || errorMsg.includes("fetch")) {
          return "Network connection error. Please check your internet connection.";
        }

        if (errorMsg.includes("cors") || errorMsg.includes("cross-origin")) {
          return "File cannot be accessed due to security restrictions.";
        }

        if (fileExtension === ".pdf") {
          return "PDF file is corrupted or unreadable. Please try a different PDF file.";
        }

        if (fileExtension === ".docx") {
          return "Word file is corrupted or unreadable. Please try a different Word file.";
        }

        if (errorMsg.includes("size") || errorMsg.includes("large")) {
          return "File is too large. Please select a file smaller than 10MB.";
        }

        if (errorMsg.includes("format") || errorMsg.includes("invalid")) {
          return "File format not supported. Only .txt, .pdf, .docx are supported";
        }

        return `Unknown error: ${error.message}`;
      }

      function getComparisonErrorMessage(error) {
        const errorMsg = error.message.toLowerCase();

        if (
          errorMsg.includes("network") ||
          errorMsg.includes("fetch") ||
          errorMsg.includes("failed to fetch")
        ) {
          return "Unable to connect to server. Please check your network connection.";
        }

        if (errorMsg.includes("cors") || errorMsg.includes("cross-origin")) {
          return "CORS error. Please check N8N webhook configuration.";
        }

        if (errorMsg.includes("timeout")) {
          return "Request timeout. File may be too large or server is busy.";
        }

        if (errorMsg.includes("500") || errorMsg.includes("internal server")) {
          return "Server error. Please check N8N logs and try again.";
        }

        if (errorMsg.includes("404") || errorMsg.includes("not found")) {
          return "N8N endpoint not found. Please check webhook URL.";
        }

        if (errorMsg.includes("400") || errorMsg.includes("bad request")) {
          return "Invalid data sent. Please check file content.";
        }

        return `Unknown error: ${error.message}`;
      }

      // ===== SMOOTH SCROLLING ENHANCEMENTS =====

      class SmoothScrollManager {
        constructor() {
          this.leftPanel = null;
          this.rightPanel = null;
          this.isScrolling = false;
          this.scrollTimeout = null;
          this.syncScrolling = false;
          this.lastScrollTime = 0;
          this.scrollVelocity = 0;
          this.momentumAnimation = null;

          this.init();
        }

        init() {
          // Initialize scroll synchronization when panels are created
          this.setupScrollSynchronization();
          this.createScrollToTopButton();
          this.setupMomentumScrolling();
          this.setupScrollIndicators();
        }

        setupScrollSynchronization() {
          // This will be called when diff panels are created
          document.addEventListener("DOMContentLoaded", () => {
            this.findScrollPanels();
          });
        }

        findScrollPanels() {
          this.leftPanel = document.querySelector("#side1 .file-content-view");
          this.rightPanel = document.querySelector("#side2 .file-content-view");

          if (this.leftPanel && this.rightPanel) {
            this.bindScrollEvents();
          }
        }

        bindScrollEvents() {
          let leftScrolling = false;
          let rightScrolling = false;

          // Enhanced scroll synchronization with smooth transitions
          this.leftPanel.addEventListener("scroll", (e) => {
            if (!rightScrolling) {
              leftScrolling = true;
              this.syncScroll(this.leftPanel, this.rightPanel);
              this.handleScrollStart(this.leftPanel);

              clearTimeout(this.scrollTimeout);
              this.scrollTimeout = setTimeout(() => {
                leftScrolling = false;
                this.handleScrollEnd(this.leftPanel);
              }, 150);
            }
          });

          this.rightPanel.addEventListener("scroll", (e) => {
            if (!leftScrolling) {
              rightScrolling = true;
              this.syncScroll(this.rightPanel, this.leftPanel);
              this.handleScrollStart(this.rightPanel);

              clearTimeout(this.scrollTimeout);
              this.scrollTimeout = setTimeout(() => {
                rightScrolling = false;
                this.handleScrollEnd(this.rightPanel);
              }, 150);
            }
          });

          // Add smooth scroll behavior
          [this.leftPanel, this.rightPanel].forEach((panel) => {
            panel.style.scrollBehavior = "smooth";
            this.setupWheelScrolling(panel);
          });
        }

        syncScroll(sourcePanel, targetPanel) {
          if (!this.syncScrolling) {
            this.syncScrolling = true;

            // Calculate scroll ratio
            const scrollRatio =
              sourcePanel.scrollTop /
              (sourcePanel.scrollHeight - sourcePanel.clientHeight);
            const targetScrollTop =
              scrollRatio *
              (targetPanel.scrollHeight - targetPanel.clientHeight);

            // Smooth scroll to target position
            targetPanel.scrollTo({
              top: targetScrollTop,
              behavior: "smooth",
            });

            // Add visual sync indicator
            this.showSyncIndicator(sourcePanel.closest(".diff-side"));

            setTimeout(() => {
              this.syncScrolling = false;
            }, 100);
          }
        }

        setupWheelScrolling(panel) {
          // Advanced scroll tracking for adaptive acceleration
          let scrollHistory = [];
          let lastScrollTime = 0;
          let momentumTimer = null;

          panel.addEventListener(
            "wheel",
            (e) => {
              e.preventDefault();

              const currentTime = Date.now();
              const delta = e.deltaY;

              // Track scroll velocity for adaptive acceleration
              scrollHistory.push({ time: currentTime, delta: Math.abs(delta) });

              // Keep only recent scroll events (last 200ms)
              scrollHistory = scrollHistory.filter(
                (event) => currentTime - event.time < 200
              );

              // Calculate adaptive multiplier based on scroll frequency and velocity
              let baseMultiplier = 10; // Increased from 2.5 to 10
              let adaptiveMultiplier = baseMultiplier;

              if (scrollHistory.length > 3) {
                // Fast consecutive scrolling - increase multiplier up to 25x
                const avgVelocity =
                  scrollHistory.reduce((sum, event) => sum + event.delta, 0) /
                  scrollHistory.length;
                const scrollFrequency = scrollHistory.length / 0.2; // events per second

                if (avgVelocity > 50 && scrollFrequency > 10) {
                  adaptiveMultiplier = Math.min(25, baseMultiplier * 2.5);
                } else if (avgVelocity > 30 && scrollFrequency > 5) {
                  adaptiveMultiplier = Math.min(20, baseMultiplier * 2);
                } else if (scrollFrequency > 3) {
                  adaptiveMultiplier = Math.min(15, baseMultiplier * 1.5);
                }
              }

              const scrollAmount = delta * adaptiveMultiplier;

              // Calculate new scroll position
              const newScrollTop = panel.scrollTop + scrollAmount;

              // Ultra-fast scroll to new position
              panel.scrollTo({
                top: Math.max(
                  0,
                  Math.min(
                    newScrollTop,
                    panel.scrollHeight - panel.clientHeight
                  )
                ),
                behavior: "auto",
              });

              // Clear momentum timer
              if (momentumTimer) {
                clearTimeout(momentumTimer);
              }

              // Add momentum scrolling effect
              momentumTimer = setTimeout(() => {
                if (scrollHistory.length > 2) {
                  const lastDelta =
                    scrollHistory[scrollHistory.length - 1].delta;
                  const momentum = lastDelta * adaptiveMultiplier * 0.3;

                  if (momentum > 10) {
                    const momentumScrollTop =
                      panel.scrollTop + (delta > 0 ? momentum : -momentum);
                    panel.scrollTo({
                      top: Math.max(
                        0,
                        Math.min(
                          momentumScrollTop,
                          panel.scrollHeight - panel.clientHeight
                        )
                      ),
                      behavior: "auto",
                    });
                  }
                }
                scrollHistory = [];
              }, 100);

              lastScrollTime = currentTime;
            },
            { passive: false }
          );
        }

        handleScrollStart(panel) {
          panel.classList.add("scrolling");
          this.isScrolling = true;

          // Add scroll highlight to visible lines
          this.highlightVisibleLines(panel);
        }

        handleScrollEnd(panel) {
          panel.classList.remove("scrolling");
          this.isScrolling = false;

          // Remove scroll highlights
          this.removeScrollHighlights(panel);
        }

        highlightVisibleLines(panel) {
          const lines = panel.querySelectorAll(".line-container");
          const panelRect = panel.getBoundingClientRect();

          lines.forEach((line) => {
            const lineRect = line.getBoundingClientRect();
            const isVisible =
              lineRect.top >= panelRect.top &&
              lineRect.bottom <= panelRect.bottom;

            if (isVisible) {
              line.classList.add("scroll-highlight");
            } else {
              line.classList.remove("scroll-highlight");
            }
          });
        }

        removeScrollHighlights(panel) {
          const lines = panel.querySelectorAll(
            ".line-container.scroll-highlight"
          );
          lines.forEach((line) => {
            line.classList.remove("scroll-highlight");
          });
        }

        showSyncIndicator(diffSide) {
          diffSide.classList.add("syncing");
          setTimeout(() => {
            diffSide.classList.remove("syncing");
          }, 1000);
        }

        createScrollToTopButton() {
          const scrollButton = document.createElement("button");
          scrollButton.className = "scroll-to-top";
          scrollButton.innerHTML = "‚Üë";
          scrollButton.title = "Scroll to top";

          scrollButton.addEventListener("click", () => {
            if (this.leftPanel && this.rightPanel) {
              this.leftPanel.scrollTo({ top: 0, behavior: "auto" });
              this.rightPanel.scrollTo({ top: 0, behavior: "auto" });
            }
          });

          document.body.appendChild(scrollButton);

          // Show/hide button based on scroll position
          window.addEventListener("scroll", () => {
            if (window.pageYOffset > 300) {
              scrollButton.classList.add("visible");
            } else {
              scrollButton.classList.remove("visible");
            }
          });
        }

        setupMomentumScrolling() {
          // Enhanced momentum scrolling for better mobile experience
          document.addEventListener(
            "touchstart",
            (e) => {
              this.lastScrollTime = Date.now();
              this.scrollVelocity = 0;
            },
            { passive: true }
          );

          document.addEventListener(
            "touchmove",
            (e) => {
              const currentTime = Date.now();
              const timeDelta = currentTime - this.lastScrollTime;

              if (timeDelta > 0) {
                this.scrollVelocity = e.touches[0].clientY / timeDelta;
                this.lastScrollTime = currentTime;
              }
            },
            { passive: true }
          );

          document.addEventListener(
            "touchend",
            (e) => {
              if (Math.abs(this.scrollVelocity) > 0.5) {
                this.startMomentumScroll();
              }
            },
            { passive: true }
          );
        }

        startMomentumScroll() {
          if (this.momentumAnimation) {
            cancelAnimationFrame(this.momentumAnimation);
          }

          const animate = () => {
            if (Math.abs(this.scrollVelocity) > 0.1) {
              if (this.leftPanel && this.rightPanel) {
                const scrollAmount = this.scrollVelocity * 10;

                this.leftPanel.scrollBy({
                  top: scrollAmount,
                  behavior: "smooth",
                });

                this.rightPanel.scrollBy({
                  top: scrollAmount,
                  behavior: "smooth",
                });
              }

              this.scrollVelocity *= 0.95; // Friction
              this.momentumAnimation = requestAnimationFrame(animate);
            }
          };

          this.momentumAnimation = requestAnimationFrame(animate);
        }

        setupScrollIndicators() {
          // Add scroll progress indicators
          const createProgressIndicator = (panel, side) => {
            const indicator = document.createElement("div");
            indicator.className = `scroll-progress scroll-progress-${side}`;
            indicator.style.cssText = `
                        position: absolute;
                        top: 0;
                        right: 0;
                        width: 4px;
                        height: 0%;
                        background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
                        transition: height 0.2s ease;
                        z-index: 10;
                        border-radius: 0 0 2px 2px;
                    `;

            panel.parentElement.style.position = "relative";
            panel.parentElement.appendChild(indicator);

            panel.addEventListener("scroll", () => {
              const scrollPercent =
                (panel.scrollTop / (panel.scrollHeight - panel.clientHeight)) *
                100;
              indicator.style.height = `${Math.min(
                100,
                Math.max(0, scrollPercent)
              )}%`;
            });
          };

          // This will be called when panels are available
          const checkPanels = () => {
            if (this.leftPanel && this.rightPanel) {
              createProgressIndicator(this.leftPanel, "left");
              createProgressIndicator(this.rightPanel, "right");
            } else {
              setTimeout(checkPanels, 100);
            }
          };

          checkPanels();
        }

        // Method to reinitialize when new content is loaded
        reinitialize() {
          this.findScrollPanels();
        }
      }

      // Initialize smooth scroll manager
      const smoothScrollManager = new SmoothScrollManager();

      // Reinitialize scroll manager when comparison is complete
      // Listen for when diff content is loaded
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === "childList" && mutation.addedNodes.length > 0) {
            // Check if diff content was added
            const hasFileContent = Array.from(mutation.addedNodes).some(
              (node) =>
                node.nodeType === Node.ELEMENT_NODE &&
                (node.classList?.contains("file-content-view") ||
                  node.querySelector?.(".file-content-view"))
            );

            if (hasFileContent) {
              setTimeout(() => {
                smoothScrollManager.reinitialize();
              }, 100);
            }
          }
        });
      });

      // Start observing the document for changes
      observer.observe(document.body, {
        childList: true,
        subtree: true,
      });

      // Advanced keyboard navigation for ultra-fast reading
      document.addEventListener("keydown", (e) => {
        if (smoothScrollManager.leftPanel && smoothScrollManager.rightPanel) {
          // Don't interfere with input fields
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") {
            return;
          }

          const lineHeight = 20; // Approximate line height
          const viewportHeight = smoothScrollManager.leftPanel.clientHeight;
          const pageScrollAmount = viewportHeight * 0.9; // 90% of viewport for page scroll
          const lineScrollAmount = lineHeight * 3; // 3 lines at a time
          const fastScrollAmount = lineHeight * 10; // 10 lines for fast navigation

          switch (e.key) {
            // Space/Shift+Space for page navigation (like PDF readers)
            case " ":
              e.preventDefault();
              const pageAmount = e.shiftKey
                ? -pageScrollAmount
                : pageScrollAmount;
              smoothScrollManager.leftPanel.scrollBy({
                top: pageAmount,
                behavior: "auto",
              });
              smoothScrollManager.rightPanel.scrollBy({
                top: pageAmount,
                behavior: "auto",
              });
              break;

            // J/K for line-by-line navigation (Vim-style)
            case "j":
            case "J":
              e.preventDefault();
              smoothScrollManager.leftPanel.scrollBy({
                top: lineScrollAmount,
                behavior: "auto",
              });
              smoothScrollManager.rightPanel.scrollBy({
                top: lineScrollAmount,
                behavior: "auto",
              });
              break;

            case "k":
            case "K":
              e.preventDefault();
              smoothScrollManager.leftPanel.scrollBy({
                top: -lineScrollAmount,
                behavior: "auto",
              });
              smoothScrollManager.rightPanel.scrollBy({
                top: -lineScrollAmount,
                behavior: "auto",
              });
              break;

            // Page Up/Page Down for fast page navigation
            case "PageUp":
              e.preventDefault();
              smoothScrollManager.leftPanel.scrollBy({
                top: -pageScrollAmount,
                behavior: "auto",
              });
              smoothScrollManager.rightPanel.scrollBy({
                top: -pageScrollAmount,
                behavior: "auto",
              });
              break;

            case "PageDown":
              e.preventDefault();
              smoothScrollManager.leftPanel.scrollBy({
                top: pageScrollAmount,
                behavior: "auto",
              });
              smoothScrollManager.rightPanel.scrollBy({
                top: pageScrollAmount,
                behavior: "auto",
              });
              break;

            // Arrow keys for precise control
            case "ArrowUp":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                smoothScrollManager.leftPanel.scrollBy({
                  top: -fastScrollAmount,
                  behavior: "auto",
                });
                smoothScrollManager.rightPanel.scrollBy({
                  top: -fastScrollAmount,
                  behavior: "auto",
                });
              }
              break;

            case "ArrowDown":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                smoothScrollManager.leftPanel.scrollBy({
                  top: fastScrollAmount,
                  behavior: "auto",
                });
                smoothScrollManager.rightPanel.scrollBy({
                  top: fastScrollAmount,
                  behavior: "auto",
                });
              }
              break;

            // Home/End for document navigation
            case "Home":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                smoothScrollManager.leftPanel.scrollTo({
                  top: 0,
                  behavior: "auto",
                });
                smoothScrollManager.rightPanel.scrollTo({
                  top: 0,
                  behavior: "auto",
                });
              }
              break;

            case "End":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                smoothScrollManager.leftPanel.scrollTo({
                  top: smoothScrollManager.leftPanel.scrollHeight,
                  behavior: "auto",
                });
                smoothScrollManager.rightPanel.scrollTo({
                  top: smoothScrollManager.rightPanel.scrollHeight,
                  behavior: "auto",
                });
              }
              break;

            // G for "Go to" navigation (Vim-style)
            case "g":
            case "G":
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.shiftKey || e.key === "G") {
                  // Go to end
                  smoothScrollManager.leftPanel.scrollTo({
                    top: smoothScrollManager.leftPanel.scrollHeight,
                    behavior: "auto",
                  });
                  smoothScrollManager.rightPanel.scrollTo({
                    top: smoothScrollManager.rightPanel.scrollHeight,
                    behavior: "auto",
                  });
                } else {
                  // Go to beginning
                  smoothScrollManager.leftPanel.scrollTo({
                    top: 0,
                    behavior: "auto",
                  });
                  smoothScrollManager.rightPanel.scrollTo({
                    top: 0,
                    behavior: "auto",
                  });
                }
              }
              break;
          }
        }
      });

      // === DIFFERENCE NAVIGATION SYSTEM ===
      let currentDifferences = [];
      let currentDiffIndex = -1;

      // === ROBUST RENDERER GATE ===
      function waitForDiffRendered({ timeout = 2000, interval = 100 } = {}) {
        return new Promise((resolve, reject) => {
          const startTime = Date.now();

          function checkForDiffs() {
            // Use the exact same selectors as updateDifferenceCounter
            const diffSelectors =
              ".line.added, .line.modified-old, .line.modified-new, .line-container.removed, .line-container.added, .line-container.modified";

            // Check both panes using the same logic as updateDifferenceCounter
            const leftPanel = document.querySelector(".file-content-view");
            const rightPanel = document.querySelector(
              ".file-content-view:last-child"
            );

            if (leftPanel && rightPanel) {
              const leftDiffs = leftPanel.querySelectorAll(diffSelectors);
              const rightDiffs = rightPanel.querySelectorAll(diffSelectors);

              // If we find any differences, resolve immediately
              if (leftDiffs.length > 0 || rightDiffs.length > 0) {
                resolve();
                return;
              }

              // Also check if the panels have content but no differences (identical files)
              const leftContent = leftPanel.querySelector(
                ".line, .line-container"
              );
              const rightContent = rightPanel.querySelector(
                ".line, .line-container"
              );

              if (leftContent && rightContent) {
                // Content is loaded but no differences found - this is valid (identical files)
                resolve();
                return;
              }
            }

            // Check timeout
            if (Date.now() - startTime >= timeout) {
              reject(new Error("Timeout waiting for diff DOM to render"));
              return;
            }

            // Schedule next check
            setTimeout(checkForDiffs, interval);
          }

          checkForDiffs();
        });
      }

      // === STATE MANAGEMENT HELPERS ===
      function setHasDiff(has) {
        document.body.dataset.hasDiff = has ? "true" : "false";
      }

      function setEmptyDiffState() {
        setHasDiff(false);
        const c = document.getElementById("diffCounterContainer");
        const dd = document.querySelector(".diff-dropdown");
        if (c) c.style.display = "none"; // Hide counter when no differences
        dd?.classList?.remove("show");
        updateCounterText(0); // "0 differences"
      }

      function updateCounterText(n) {
        const el = document.querySelector("#diffCountText, #totalDiffText");
        if (el) el.textContent = `${n} difference${n !== 1 ? "s" : ""}`;
      }

      // New race-condition-free functions to replace the old updateDifferenceCounter
      function waitForDiffReady(timeout = 2000) {
        return new Promise((resolve) => {
          const t0 = performance.now();
          (function check() {
            const ready =
              document.querySelectorAll(
                "#side1 .line-container, #side2 .line-container"
              ).length > 0;
            if (ready || performance.now() - t0 > timeout) return resolve();
            requestAnimationFrame(check);
          })();
        });
      }

      async function refreshDiffUI() {
        await waitForDiffReady(); // ch·ªù c√°c .line-container xu·∫•t hi·ªán
        DiffFlow.onRendered(); // s·ª≠ d·ª•ng DiffFlow thay v√¨ initDiffUI c≈©
      }

      // Add event listeners for navigation buttons
      document.addEventListener("DOMContentLoaded", function () {
        const prevBtn = document.getElementById("prevDiffBtn");
        const nextBtn = document.getElementById("nextDiffBtn");
        const diffCountText = document.getElementById("diffCountText");

        if (prevBtn) {
          prevBtn.addEventListener("click", function () {
            navigateToDiff(-1);
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", function () {
            navigateToDiff(1);
          });
        }

        // Add click handler for total differences counter
        const totalDiffCounter = document.getElementById("totalDiffCounter");
        if (totalDiffCounter) {
          totalDiffCounter.addEventListener("click", function (event) {
            event.stopPropagation();
            // Toggle dropdown if there are differences
            if (currentDifferences.length > 0) {
              toggleDropdown();
            }
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", function (event) {
          const dropdown = document.getElementById("diffDropdown");
          const summaryContainer = document.getElementById(
            "diffSummaryContainer"
          );

          if (
            dropdown &&
            summaryContainer &&
            !summaryContainer.contains(event.target)
          ) {
            toggleDropdown(false);
          }
        });
      });

      // === UNIFIED DIFF INITIALIZATION PIPELINE ===
      // === DIFFFLOW SOLUTION - FIX JAVASCRIPT COUNTING ISSUES ===
      (() => {
        // ====== UI refs ======
        const ui = {
          totalText: document.getElementById("totalDiffText"), // <span id="totalDiffText">0 differences</span>
          dropdown: document.querySelector(".diff-dropdown"),
          listBox: document.querySelector(".diff-dropdown-list"),
          prevBtn: document.getElementById("jumpPrev"),
          nextBtn: document.getElementById("jumpNext"),
        };

        // ====== Internal state ======
        const state = {
          anchors: [], // DOM nodes c·ªßa t·ª´ng diff line
          idx: 0,
          mo: null, // MutationObserver
          wired: false, // ch·∫∑n bind l·∫∑p
        };

        // ====== Helpers ======
        function getPanes() {
          // ƒê·ªïi selector cho ƒë√∫ng 2 v√πng scroller c·ªßa b·∫°n
          const left =
            document.querySelector("#side1 .file-content-view") || null;
          const right =
            document.querySelector("#side2 .file-content-view") || null;
          return { left, right };
        }

        function clearState() {
          // D·ªçn s·∫°ch m·ªçi th·ª© gi·ªØa 2 l·∫ßn compare
          state.anchors = [];
          state.idx = 0;
          if (state.mo) {
            state.mo.disconnect();
            state.mo = null;
          }
          if (ui.listBox) ui.listBox.innerHTML = "";
          if (ui.dropdown) ui.dropdown.classList.remove("show");
          if (ui.totalText) ui.totalText.textContent = "0 differences";
        }

        function collectAnchors() {
          const { left, right } = getPanes();
          const Q =
            ".line.added, .line.removed, .line.modified-old, .line.modified-new," +
            ".line-container.added, .line-container.removed, .line-container.modified," +
            ".line-container.has-addition, .line-container.has-deletion, .line-container.has-modification";

          const L = left ? [...left.querySelectorAll(Q)] : [];
          const R = right ? [...right.querySelectorAll(Q)] : [];

          // Create a map to track unique differences by line number or position
          const differenceMap = new Map();
          
          L.forEach((el, i) => {
            if (!el.id) el.id = `A-${i + 1}`;
            el.dataset.pane = "A";
            
            // Extract line number or use position as key
            const lineNum = extractLineNumber(el) || el.offsetTop;
            const key = `line-${lineNum}`;
            
            if (!differenceMap.has(key)) {
              differenceMap.set(key, {
                elements: [el],
                position: el.offsetTop,
                lineNumber: lineNum
              });
            } else {
              differenceMap.get(key).elements.push(el);
            }
          });
          
          R.forEach((el, i) => {
            if (!el.id) el.id = `B-${i + 1}`;
            el.dataset.pane = "B";
            
            // Extract line number or use position as key
            const lineNum = extractLineNumber(el) || el.offsetTop;
            const key = `line-${lineNum}`;
            
            if (!differenceMap.has(key)) {
              differenceMap.set(key, {
                elements: [el],
                position: el.offsetTop,
                lineNumber: lineNum
              });
            } else {
              differenceMap.get(key).elements.push(el);
            }
          });

          // Convert map to sorted array of primary elements (one per difference)
          const sortedDifferences = Array.from(differenceMap.values())
            .sort((a, b) => a.position - b.position)
            .map(diff => diff.elements[0]); // Take the first element as representative

          return sortedDifferences;
        }

        function extractLineNumber(element) {
          // Try to extract line number from various possible sources
          const lineNumberEl = element.querySelector('.line-number');
          if (lineNumberEl) {
            const num = parseInt(lineNumberEl.textContent);
            if (!isNaN(num)) return num;
          }
          
          // Try to get from data attributes
          if (element.dataset.lineNumber) {
            const num = parseInt(element.dataset.lineNumber);
            if (!isNaN(num)) return num;
          }
          
          // Try to get from ID if it contains line info
          if (element.id && element.id.includes('-')) {
            const parts = element.id.split('-');
            const num = parseInt(parts[parts.length - 1]);
            if (!isNaN(num)) return num;
          }
          
          return null;
        }

        function updateTotalCounter() {
          const n = state.anchors.length;
          if (ui.totalText)
            ui.totalText.textContent = `${n} difference${n !== 1 ? "s" : ""}`;
        }

        function buildDropdown() {
          if (!ui.listBox) return;
          ui.listBox.innerHTML = "";
          
          // Get file names for display
          const file1Name = document.getElementById('file1-title')?.textContent || 'File 1';
          const file2Name = document.getElementById('file2-title')?.textContent || 'File 2';
          
          state.anchors.forEach((el, i) => {
            const type =
              el.classList.contains("added") ||
              el.classList.contains("has-addition")
                ? "addition"
                : el.classList.contains("removed") ||
                  el.classList.contains("has-deletion")
                ? "removal"
                : "modification";
            
            // Determine which file and direction
            const pane = el.dataset.pane || "?";
            const isLeftPane = pane === "A";
            const currentFileName = isLeftPane ? file1Name : file2Name;
            const otherFileName = isLeftPane ? file2Name : file1Name;
            
            // Create direction indicator
            let directionInfo = "";
            let fileChangeInfo = "";
            
            if (type === "addition") {
              directionInfo = `<span class="file-direction addition">‚Üí ${currentFileName}</span>`;
              fileChangeInfo = `Added to ${currentFileName}`;
            } else if (type === "removal") {
              directionInfo = `<span class="file-direction removal">${currentFileName} ‚Üí</span>`;
              fileChangeInfo = `Removed from ${currentFileName}`;
            } else {
              directionInfo = `<span class="file-direction modification">${file1Name} ‚Üí ${file2Name}</span>`;
              fileChangeInfo = `Changed from ${file1Name} to ${file2Name}`;
            }
            
            // Extract actual content from the diff element
            let contentPreview = "";
            let beforeText = "";
            let afterText = "";
            
            try {
              // Try to get content from line containers
              const lineContainer = el.closest('.line-container') || el;
              const lineContentEl = lineContainer.querySelector('.line-content');
              
              if (lineContentEl) {
                const fullText = lineContentEl.textContent || lineContentEl.innerText || "";
                contentPreview = fullText.length > 50 ? fullText.substring(0, 50) + "..." : fullText;
                
                // For modifications, try to extract before/after content
                if (type === "modification") {
                  const deletedSpans = lineContentEl.querySelectorAll('.inline-deleted');
                  const addedSpans = lineContentEl.querySelectorAll('.inline-added');
                  
                  if (deletedSpans.length > 0) {
                    beforeText = Array.from(deletedSpans).map(span => span.textContent).join('');
                  }
                  if (addedSpans.length > 0) {
                    afterText = Array.from(addedSpans).map(span => span.textContent).join('');
                  }
                }
              }
              
              // Fallback to element text content
              if (!contentPreview) {
                const fullText = el.textContent || el.innerText || "";
                contentPreview = fullText.length > 50 ? fullText.substring(0, 50) + "..." : fullText;
              }
            } catch (error) {
              contentPreview = `Line ${i + 1}`;
            }
            
            const item = document.createElement("div");
            item.className = "diff-dropdown-item";
            
            let itemHTML = `
              <div class="diff-item-header">
                <span class="diff-item-type ${type}">${type.toUpperCase()}</span>
                <span class="diff-item-line">Line ${i + 1}</span>
              </div>
              <div class="diff-file-info">
                <div class="file-change-description">${fileChangeInfo}</div>
                <div class="file-direction-indicator">${directionInfo}</div>
              </div>
              <div class="diff-item-content">
                <div class="diff-content-preview">${contentPreview || `${type.charAt(0).toUpperCase() + type.slice(1)} at line ${i + 1}`}</div>`;
            
            // Add before/after preview for modifications
            if (type === "modification" && (beforeText || afterText)) {
              itemHTML += `
                <div class="diff-change-preview">
                  ${beforeText ? `<div class="diff-before"><span class="diff-label">Before:</span> ${beforeText.length > 30 ? beforeText.substring(0, 30) + "..." : beforeText}</div>` : ''}
                  ${afterText ? `<div class="diff-after"><span class="diff-label">After:</span> ${afterText.length > 30 ? afterText.substring(0, 30) + "..." : afterText}</div>` : ''}
                </div>`;
            }
            
            itemHTML += `
              </div>`;
            
            item.innerHTML = itemHTML;
            item.onclick = (e) => {
              e.stopPropagation();
              
              // Remove active class from all dropdown items
              document.querySelectorAll('.diff-dropdown-item').forEach(dropdownItem => {
                dropdownItem.classList.remove('active');
              });
              
              // Add active class to clicked item
              item.classList.add('active');
              
              // Close dropdown after a short delay to show the active state
              setTimeout(() => {
                ui.dropdown?.classList?.remove("show");
              }, 150);
              
              state.idx = i;
              scrollToAnchor(el);
            };
            ui.listBox.appendChild(item);
          });
        }

        function scrollToAnchor(el) {
          if (!el) return;
          
          const { left, right } = getPanes();
          if (!left && !right) return;
          
          // Remove previous highlights
          document.querySelectorAll('.diff-highlight').forEach(highlightedEl => {
            highlightedEl.classList.remove('diff-highlight');
          });
          
          // Determine which pane the element belongs to
          let targetPane = null;
          if (el.dataset?.pane === "A") {
            targetPane = left;
          } else if (el.dataset?.pane === "B") {
            targetPane = right;
          } else {
            // Fallback: check which pane contains the element
            if (left && left.contains(el)) {
              targetPane = left;
            } else if (right && right.contains(el)) {
              targetPane = right;
            }
          }
          
          if (!targetPane) {
            console.warn('Could not determine target pane for element:', el);
            return;
          }
          
          // Calculate scroll position relative to the target pane
          const paneRect = targetPane.getBoundingClientRect();
          const elRect = el.getBoundingClientRect();
          const currentScrollTop = targetPane.scrollTop;
          const targetScrollTop = Math.max(0, currentScrollTop + (elRect.top - paneRect.top) - 100);
          
          // Smooth scroll to element
          targetPane.scrollTo({
            top: targetScrollTop,
            behavior: 'smooth'
          });
          
          // Add enhanced highlight effect
          el.classList.add("diff-highlight");
          
          // Also highlight the corresponding line container for better visibility
          const lineContainer = el.closest('.line-container');
          if (lineContainer) {
            lineContainer.classList.add("diff-highlight");
            setTimeout(() => lineContainer.classList.remove("diff-highlight"), 2000);
          }
          
          // Remove highlight after delay
          setTimeout(() => el.classList.remove("diff-highlight"), 2000);
        }

        function wireOnce() {
          if (state.wired) return;
          state.wired = true;

          // Toggle dropdown when clicking on total text/counter
          ui.totalText?.parentElement?.addEventListener("click", (e) => {
            e.stopPropagation();
            ui.dropdown?.classList?.toggle("show");
          });

          ui.prevBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!state.anchors.length) return;
            state.idx =
              (state.idx - 1 + state.anchors.length) % state.anchors.length;
            scrollToAnchor(state.anchors[state.idx]);
          });

          ui.nextBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!state.anchors.length) return;
            state.idx = (state.idx + 1) % state.anchors.length;
            scrollToAnchor(state.anchors[state.idx]);
          });

          document.addEventListener("click", () =>
            ui.dropdown?.classList?.remove("show")
          );
        }

        // Wait until DOM diff is actually present (don't use hard timeout)
        function waitForDiffRendered({ timeout = 5000, interval = 120 } = {}) {
          const start = performance.now();
          const want = () => {
            const { left, right } = getPanes();
            const sel = ".line, .line-container";
            return (
              (left && left.querySelector(sel)) ||
              (right && right.querySelector(sel))
            );
          };
          return new Promise((resolve, reject) => {
            (function tick() {
              if (want()) return resolve();
              if (performance.now() - start > timeout)
                return reject(new Error("diff-dom-timeout"));
              setTimeout(tick, interval);
            })();
          });
        }

        // Initialize after DOM diff is ready
        function initAfterRender() {
          state.anchors = collectAnchors();
          updateTotalCounter();
          buildDropdown();
          wireOnce();

          // Monitor DOM changes in panes (if renderer continues to add content)
          const { left, right } = getPanes();
          if (state.mo) {
            state.mo.disconnect();
            state.mo = null;
          }
          const mo = new MutationObserver(() => {
            state.anchors = collectAnchors();
            updateTotalCounter();
            buildDropdown();
          });
          left && mo.observe(left, { childList: true, subtree: true });
          right && mo.observe(right, { childList: true, subtree: true });
          state.mo = mo;
        }

        // ===== Public API ‚Äì call these 3 functions in your flow =====
        window.DiffFlow = {
          // 1) call immediately when starting comparison
          begin() {
            clearState(); // CLEAR previous state completely
          },

          // 2) call IMMEDIATELY AFTER you render/append HTML diff to 2 panes
          async onRendered() {
            // ensure DOM has appeared, avoid "first time = 0"
            // use double rAF to ensure browser has painted
            await waitForDiffRendered().catch(() => {});
            await new Promise((r) =>
              requestAnimationFrame(() => requestAnimationFrame(r))
            );
            initAfterRender();
          },

          // 3) call when Reset button is pressed
          reset() {
            clearState();
          },
        };

        // (Optional) if you have existing window.runComparison, patch for correct sequence
        const original = window.runComparison;
        if (original && !window.__patchedRunComparison) {
          window.__patchedRunComparison = true;
          window.runComparison = async function (...args) {
            window.DiffFlow.begin();
            const ret = original.apply(this, args); // your renderer will append DOM
            try {
              await window.DiffFlow.onRendered();
            } catch {}
            return ret;
          };
        }

        // === IMPROVED SCROLL SYNCHRONIZATION - LEADER/FOLLOWER ===
        // ƒê·ªìng b·ªô ki·ªÉu "leader ‚Üí follower" (1 khung h√¨nh, 1 l·∫ßn sync)
        (() => {
          const left = document.querySelector("#side1 .file-content-view");
          const right = document.querySelector("#side2 .file-content-view");
          if (!left || !right) return;

          let leader = null; // 'left' | 'right'
          let scheduled = false; // ƒë√£ l√™n l·ªãch sync cho frame hi·ªán t·∫°i ch∆∞a
          let from = null,
            to = null; // c·∫∑p pane leader/follower

          // X√°c ƒë·ªãnh leader khi c√≥ t∆∞∆°ng t√°c
          [
            "pointerdown",
            "wheel",
            "touchstart",
            "mouseenter",
            "keydown",
          ].forEach((evt) => {
            left.addEventListener(evt, () => (leader = "left"), {
              passive: true,
            });
            right.addEventListener(evt, () => (leader = "right"), {
              passive: true,
            });
          });

          // T√≠nh t·ªâ l·ªá cu·ªôn an to√†n (tr√°nh NaN/Infinity)
          function ratio(src, dst) {
            const sMax = Math.max(1, src.scrollHeight - src.clientHeight);
            const dMax = Math.max(1, dst.scrollHeight - dst.clientHeight);
            return dMax / sMax;
          }

          function scheduleSync() {
            if (scheduled || !from || !to) return;
            scheduled = true;

            // ƒê√°nh d·∫•u "ƒëang cu·ªôn" ƒë·ªÉ CSS t·ªëi gi·∫£n ho√° hi·ªáu ·ª©ng
            from.classList.add("scrolling");
            to.classList.add("scrolling");

            requestAnimationFrame(() => {
              const r = ratio(from, to);
              to.scrollTop = from.scrollTop * r;
              scheduled = false;

              // B·ªè tr·∫°ng th√°i "ƒëang cu·ªôn" sau m·ªôt nh·ªãp ng·∫Øn
              clearTimeout(to._scrollTimer);
              clearTimeout(from._scrollTimer);
              to._scrollTimer = setTimeout(
                () => to.classList.remove("scrolling"),
                120
              );
              from._scrollTimer = setTimeout(
                () => from.classList.remove("scrolling"),
                120
              );
            });
          }

          function onScrollLeft() {
            if (leader === "left") {
              from = left;
              to = right;
              scheduleSync();
            }
          }
          function onScrollRight() {
            if (leader === "right") {
              from = right;
              to = left;
              scheduleSync();
            }
          }

          left.addEventListener("scroll", onScrollLeft, { passive: true });
          right.addEventListener("scroll", onScrollRight, { passive: true });
        })();

        // === DRAG TO SCROLL - TƒÉng c·∫£m gi√°c ƒëi·ªÅu khi·ªÉn ===
        (() => {
          const panes = [
            document.querySelector("#side1 .file-content-view"),
            document.querySelector("#side2 .file-content-view"),
          ].filter(Boolean);
          let dragging = false,
            startY = 0,
            startTop = 0,
            target = null;

          panes.forEach((p) => {
            p.style.cursor = "grab";
            p.addEventListener(
              "pointerdown",
              (e) => {
                dragging = true;
                target = p;
                startY = e.clientY;
                startTop = p.scrollTop;
                p.setPointerCapture(e.pointerId);
                p.style.cursor = "grabbing";
              },
              { passive: true }
            );
            p.addEventListener(
              "pointermove",
              (e) => {
                if (!dragging) return;
                target.scrollTop = startTop - (e.clientY - startY);
              },
              { passive: true }
            );
            const up = (e) => {
              dragging = false;
              p.style.cursor = "grab";
              p.releasePointerCapture?.(e.pointerId);
            };
            p.addEventListener("pointerup", up, { passive: true });
            p.addEventListener("pointercancel", up, { passive: true });
          });
        })();
      })();
    </script>
  </body>
</html>
